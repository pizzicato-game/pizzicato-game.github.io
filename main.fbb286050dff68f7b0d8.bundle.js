(()=>{"use strict";var t,e={852:(t,e,i)=>{i.d(e,{Ny:()=>hi,lW:()=>mi,ID:()=>pi,vh:()=>vi});var s=i(440),n=i.n(s);function a(t){let e="layerID,noteID,loopNumber,playerTime,correctTime,classification\n";for(const i of t.layersStats){const s=t.layersStats.indexOf(i);for(const t of i.hits)e+=`${s},${t.noteID},${t.loopNumber},${o(t.playerTime)},${o(t.correctTime)},${t.classification}\n`}return e}function o(t,e=3){return parseFloat((t/1e3).toFixed(e))}const r=Phaser.Math.Vector2,h=Phaser.GameObjects.Group,l=Phaser.GameObjects.Graphics,c=Phaser.Time.TimerEvent,d=Phaser.GameObjects.GameObject,u=Phaser.Geom.Rectangle,g=(Phaser.Geom.Circle,Phaser.Input.Pointer,Phaser.GameObjects.Text),p=(Phaser.GameObjects.Sprite,Phaser.GameObjects.Video,Phaser.GameObjects.RenderTexture,Phaser.Events.EventEmitter,Phaser.GameObjects.Image,Phaser.Scene),v=(Phaser.Tilemaps.Tile,Phaser.Tweens.Tween,Phaser.GameObjects.Particles.ParticleEmitter,Phaser.Physics.Matter.Sprite),m=(Phaser.Physics.Arcade.Sprite,!0),f="levels/",y=f+"list.json",b=".mp3",w="assets/sounds/ui/menu_ding"+b,T="finger",x="previewVideoBackground",k="songNameBackground",S="layerScoreBackground",P="scoreboardBackground",L="menuCalibrateButton",C="menuSelectButton",B="optionsButton",D="targetInner",O="background1",H="mainBackground",_="playButton",I="easyButton",M="mediumButton",V="hardButton",A="backButton",E="buttonDing",K="calibrationBackground",F="menuLogo",j="resetButton",N="muteButton",z="unmuteButton",R="leftArrow",W="rightArrow",q="saveCSVButton",$="defaultLevelbackground",G="defaultPreviewbackground",J="assets/sprites/defaultTargetInner.png",U="assets/ui/back_button.png",X="assets/ui/mute_button.png",Z="assets/ui/unmute_button.png",Q="data/config.json",Y={thumb:16777215,index:14948892,middle:38655,ring:16771584,pinky:14315734},tt={lineWidth:5,color:11393254,alpha:.5},et={lineWidth:5,color:11393254,alpha:1,radius:.1},it="thumb",st="index",nt=st,at=16777215,ot=14948892,rt=D,ht="targetOuter",lt=J,ct={scale:1.03,color:16777215,ease:"linear"},dt={scale:.78,color:5091146,ease:"linear"},ut={scale:.3,color:16744192,ease:"linear"},gt={scale:0,color:8421504,ease:"cubic.in"},pt="keydown-ESC",vt={font:"32px Courier",color:"#00ff00"},mt={position:se(new r(.05,.05)),color:"white",scale:1,font:"30px Arial",depth:40,strokeThickness:0,shadowOffset:new r(2,2),shadowColor:"black",shadowBlurRadius:2},ft={color:[16436258,16291840,16266752,10421252],colorEase:"quad.out",lifespan:500,scale:{start:.7,end:0,ease:"sine.out"},speed:200,advance:500,frequency:50,blendMode:"ADD",duration:0},yt="flare",bt={position:se(new r(.5,0)),size:se(new r(.4,.04)),requiredTint:524543,completedRequiredTint:2840741,completedTint:dt.color,extraTint:dt.color,path:"assets/ui/progress_bar_segment.png",key:"segment",tintByNode:!1},wt={highKey:"metronome/high",highPath:"assets/sounds/metronome/high"+b,lowKey:"metronome/low",lowPath:"assets/sounds/metronome/low"+b},Tt="countdown",xt={position:se(new r(.5,.5)),color:"white",scale:1,ease:"Power0",font:"240px Arial",depth:30},kt={position:se(new r(.835,0)),size:new r(.16*window.innerWidth,.2684*window.innerHeight),textureKey:"infoBackground",opacity:.3,path:"assets/ui/info_background.png"},St={position:se(new r(.93,.9)),scale:new r(.3,.3),soundKey:E,textureKey:"skipButton",path:"assets/ui/skip_button.png"},Pt={position:se(new r(.85,.02)),color:"white",font:"20px Arial",scale:1,depth:40},Lt={position:se(new r(.85,.07)),color:"white",font:"20px Arial",scale:1,depth:40},Ct={position:se(new r(.85,.12)),color:"white",font:"20px Arial",scale:1,depth:40},Bt={position:se(new r(.85,.17)),color:"white",font:"20px Arial",scale:1,depth:40},Dt={position:se(new r(.85,.22)),color:"white",font:"20px Arial",scale:1,depth:40},Ot=.115,Ht=new r(.43,.43),_t=new r(.6,.6),It=new r(1.5,1.5),Mt=new r(-32,-32),Vt=new r(32,-32),At=.07,Et=.71,Kt=.75,Ft="loading",jt="level",Nt="scoreboard",zt="mainMenu",Rt="levelSelect",Wt="calibration",qt="options",$t=zt,Gt={visible:!1,flip:!0,opacity:0,width:window.innerWidth,height:window.innerHeight,objectFit:"fill"},Jt={video:{width:{ideal:640},height:{ideal:360}},audio:!1},Ut={baseOptions:{delegate:"GPU"},runningMode:"VIDEO",numHands:1,minHandDetectionConfidence:.5,minHandPresenceConfidence:.5,minTrackingConfidence:.5},Xt="UNDEFINED";var Zt=function(t,e,i,s){return new(i||(i=Promise))((function(n,a){function o(t){try{h(s.next(t))}catch(t){a(t)}}function r(t){try{h(s.throw(t))}catch(t){a(t)}}function h(t){var e;t.done?n(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(o,r)}h((s=s.apply(t,e||[])).next())}))};function Qt(t){return new Promise(((e,i)=>Zt(this,void 0,void 0,(function*(){var s;yield("GET",s=t,new Promise((function(t,e){const i=new XMLHttpRequest;i.open("GET",s),i.onload=function(){this.status>=200&&this.status<300?t(i):e({status:this.status,statusText:i.statusText})},i.onerror=function(){e({status:this.status,statusText:i.statusText})},i.send()}))).then((t=>{e(JSON.parse(t.responseText.toString("utf8")))})).catch((()=>{i()}))}))))}function Yt(t,e="no error message provided"){if(m&&!t)throw new Error("Assertion failed: "+e)}function te(t,e=""){const i="".replace(/\\/g,"/")+e;return t=t.replace(/\\/g,"/"),"/"==Array.from(t)[0]?i+t:i+"/"+t}function ee(t){return te(t,"")}function ie(t){return ee(t),!0}function se(t){return t instanceof r?new r(t.x*window.innerWidth,t.y*window.innerHeight):new r(t[0]*window.innerWidth,t[1]*window.innerHeight)}var ne=i(213),ae=i.n(ne);let oe,re;function he(t){oe=t}function le(t){return new Promise(((e,i)=>{return s=this,n=void 0,o=function*(){let s=!1;hi?oe?(s=!1,e(oe)):yield mi().then((t=>{const[i,n]=t;console.info('INFO: Playing as "'+pi()+'" with config: "'+n+'"'),s=!1,he(i),e(i)})).catch((t=>{console.info("INFO: "+t),s=!0})):s=!0,s&&(console.info("INFO: Playing as guest"),yield Qt(ee(t)).then((t=>{const i=t;he(i),e(i)})).catch((()=>{i()})))},new((a=void 0)||(a=Promise))((function(t,e){function i(t){try{h(o.next(t))}catch(t){e(t)}}function r(t){try{h(o.throw(t))}catch(t){e(t)}}function h(e){var s;e.done?t(e.value):(s=e.value,s instanceof a?s:new a((function(t){t(s)}))).then(i,r)}h((o=o.apply(s,n||[])).next())}));var s,n,a,o}))}function ce(t){if(hi){const e=JSON.parse(JSON.stringify(t));vi(t.id,e).then((t=>{console.info("INFO: "+t)})).catch((t=>{console.info("INFO: "+t)}))}}var de=function(t,e,i,s){return new(i||(i=Promise))((function(n,a){function o(t){try{h(s.next(t))}catch(t){a(t)}}function r(t){try{h(s.throw(t))}catch(t){a(t)}}function h(t){var e;t.done?n(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(o,r)}h((s=s.apply(t,e||[])).next())}))};const ue=new class{init(t,e){return de(this,void 0,void 0,(function*(){return new Promise(((i,s)=>de(this,void 0,void 0,(function*(){e("Loading webcam..."),this.setupVideoElement(t),yield navigator.mediaDevices.getUserMedia(Jt).then((t=>{"srcObject"in this.video?(this.video.srcObject=t,this.video.addEventListener("loadeddata",(()=>{i(!0)}))):s("srcObject does not exist on older browsers")})).catch((t=>{s(t)}))}))))}))}found(){return null!=this.video.srcObject}setVisibility(t){this.video.style.visibility="",this.video.style.visibility=t?"shown":"hidden"}setWidth(t){this.video.width=t}setHeight(t){this.video.height=t}setupVideoElement(t){this.video=document.body.appendChild(document.createElement("video")),this.video.autoplay=!0,this.video.muted=!0,this.video.playsInline=!0,this.video.style.objectFit=t.objectFit,this.setWidth(t.width),this.setHeight(t.height),t.flip&&(this.video.style.cssText+="-moz-transform: scale(-1, 1);          -webkit-transform: scale(-1, 1); -o-transform: scale(-1, 1);          transform: scale(-1, 1); filter: FlipH;"),this.setVisibility(!1)}get video(){return Yt(null!=this.video_),this.video_}set video(t){this.video_=t}};var ge=i(260),pe=function(t,e,i,s){return new(i||(i=Promise))((function(n,a){function o(t){try{h(s.next(t))}catch(t){a(t)}}function r(t){try{h(s.throw(t))}catch(t){a(t)}}function h(t){var e;t.done?n(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(o,r)}h((s=s.apply(t,e||[])).next())}))};const ve=new class{constructor(){this.lastVideoTime=-1}init(t){return pe(this,void 0,void 0,(function*(){return new Promise(((e,i)=>pe(this,void 0,void 0,(function*(){let s;yield ge.Ps.forVisionTasks(te("models/wasm")).then((t=>s=t)).catch((t=>{i(t)})),t("Loading hand landmarker..."),Ut.baseOptions.modelAssetPath=ee("models/hand_landmarker.task"),yield ge.Vb.createFromOptions(s,Ut).then((t=>this.handLandmarker_=t)).catch((t=>{t instanceof Event&&"error"==t.type&&i("Failed to fetch vision_wasm_internal.js in specified wasm directory"),t instanceof TypeError&&i("Failed to fetch hand_landmark.task file"),i(t)})),e(!0)}))))}))}precache(t){t("Pre-caching landmarks..."),this.update()}found(){return null!=this.handLandmarker_}update(){this.lastVideoTime!=ue.video.currentTime&&(this.lastVideoTime=ue.video.currentTime,this.results_=this.handLandmarker.detectForVideo(ue.video,performance.now()))}get results(){return Yt(null!=this.results_),this.results_}get handLandmarker(){return Yt(null!=this.handLandmarker_),this.handLandmarker_}landmarksFound(t=0){return null!=this.results&&t<this.results.landmarks.length}landmarkFound(t,e=0){if(!this.landmarksFound(e))return!1;const i=this.results.landmarks[e][t];return i.x>=0&&i.x<=1&&i.y>=0&&i.y<=1}getLandmarkPosition(t,e=0){if(!this.landmarksFound(e))return;const i=this.results.landmarks[e][t],s=se(new r(i.x,i.y));return new r(window.innerWidth-s.x,s.y)}forEachLandmarkPosition(t,e=0){for(let i=0;i<21;++i){const s=this.getLandmarkPosition(i,e);void 0!==s&&t(s)}}};var me=function(t,e,i,s){return new(i||(i=Promise))((function(n,a){function o(t){try{h(s.next(t))}catch(t){a(t)}}function r(t){try{h(s.throw(t))}catch(t){a(t)}}function h(t){var e;t.done?n(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(o,r)}h((s=s.apply(t,e||[])).next())}))};let fe;function ye(t,e){null!=t&&(t.setVisible(e),e?t.setInteractive():t.disableInteractive())}class be extends v{constructor(t,e,i,s,n){super(t.matter.world,0,0,e,void 0,{render:{visible:!0}}),this.name=i,this.landmarkIndex=s,this.scene.add.existing(this),this.setScale(n),this.setTint(Y[this.name]),this.setDepth(100),this.setCircle(this.displayWidth/2,{label:this.name}),this.setSensor(!0),ye(this,!1)}}var we,Te;!function(t){t[t.hover=0]="hover",t[t.pinch=1]="pinch"}(we||(we={})),function(t){t[t.start=0]="start",t[t.continue=1]="continue",t[t.end=2]="end"}(Te||(Te={}));class xe extends d{getFinger(t){const e=this.fingers.findIndex((e=>e.name==t));if(-1!==e)return this.fingers[e]}getFingersOtherThan(t){const e=[];for(const i of this.fingers)i.name!=t&&e.push(i);return e}get observers(){return this.observers_}isObserver(t){return void 0!==this.observers_.find((e=>e.fingerName===t.fingerName&&e.object==t.object))}wasObserverHovering(t){return Yt(this.isObserver(t)),this.observers_.find((e=>e.fingerName===t.fingerName&&e.object==t.object)).wasHovering}setObserverHover(t,e){const i=this.observers_.findIndex((e=>e.fingerName===t.fingerName&&e.object==t.object));Yt(-1!==i,"Cannot set observer hover before observer is pushed"),this.observers_[i].wasHovering=e}pushNewObserversOnly(t){this.isObserver(t)||(this.observers.push(t),this.setObserverHover(t,!1))}removeObserver(t){const e=this.observers_.findIndex((e=>e.fingerName===t.fingerName&&e.object==t.object));e>-1&&this.observers_.splice(e,1)}constructor(t){super(t,"hand"),this.fingers=[],this.observers_=[],this.fingers=[],this.observers_=[];const e=(t,e)=>{const i=new be(this.scene,T,t,e,.3*oe.fingerSize);return this.fingers.push(i),i},i=e(it,4),s=(e(st,8),e("middle",12),e("ring",16),e("pinky",20),(t,e)=>{t((t=>{const s=this.getFinger(t.bodyB.label);if(void 0!==s)for(const t of this.observers)t.fingerName==s.name&&null!=t.object&&t.object.input&&t.object.input.enabled&&t.object.emit(s.name+we.pinch+e);else if(t.bodyB.gameObject){const s=t.bodyB.gameObject;for(const n of this.fingers){if(n==i)continue;const a={object:s,fingerName:n.name};if(!this.isObserver(a))continue;const o=this.scene.matter.overlap(t.bodyB,[n]);if(e===Te.start&&o)s.emit(n.name+we.hover+Te.start),this.setObserverHover(a,!0);else if(e===Te.continue){const t=this.wasObserverHovering(a);o&&t?(s.emit(n.name+we.hover+Te.continue),this.setObserverHover(a,!0)):o&&!t?(s.emit(n.name+we.hover+Te.start),this.setObserverHover(a,!0)):!o&&t&&(s.emit(n.name+we.hover+Te.end),this.setObserverHover(a,!1))}else e===Te.end&&this.wasObserverHovering(a)&&(s.emit(n.name+we.hover+Te.end),this.setObserverHover(a,!1))}}}))});s(i.setOnCollide.bind(i),Te.start),s(i.setOnCollideActive.bind(i),Te.continue),s(i.setOnCollideEnd.bind(i),Te.end)}setFingerScale(t){for(const e of this.fingers)e.setScale(.3*t)}addPinchCheck(t,e,i){this.pushNewObserversOnly({object:e,fingerName:t});const s=t=>{const i=this.getFinger(it),s=this.getFinger(t);if(void 0===i)return!1;if(void 0===s)return!1;const n=this.scene.matter.overlap(e,[i]),a=this.scene.matter.overlap(e,[s]);return n&&a},n=t=>{const e=this.getFingersOtherThan(t),i=this.getFinger(it);if(void 0===i)return!1;for(const t of e)if(t!=i&&void 0!==t&&this.scene.matter.overlap(i,[t]))return!0;return!1};null!=i.startPinch&&e.on(t+we.pinch+Te.start,(()=>{var e;s(t)&&(!oe.singlePinchRequirement||oe.singlePinchRequirement&&!n(t))&&(null===(e=i.startPinch)||void 0===e||e.call(i))})),null!=i.pinched&&e.on(t+we.pinch+Te.continue,(()=>{var e;s(t)&&(!oe.singlePinchRequirement||oe.singlePinchRequirement&&!n(t))&&(null===(e=i.pinched)||void 0===e||e.call(i))})),null!=i.endPinch&&e.on(t+we.pinch+Te.end,(()=>{var e;s(t)&&(!oe.singlePinchRequirement||oe.singlePinchRequirement&&!n(t))&&(null===(e=i.endPinch)||void 0===e||e.call(i))})),null!=i.startHover&&e.on(t+we.hover+Te.start,(()=>{var t;null===(t=i.startHover)||void 0===t||t.call(i)})),null!=i.hovering&&e.on(t+we.hover+Te.continue,(()=>{var t;null===(t=i.hovering)||void 0===t||t.call(i)})),null!=i.endHover&&e.on(t+we.hover+Te.end,(()=>{var t;null===(t=i.endHover)||void 0===t||t.call(i)}))}removePinchCheck(t,e){this.removeObserver({fingerName:t,object:e}),e.off(t+we.pinch+Te.start),e.off(t+we.pinch+Te.continue),e.off(t+we.pinch+Te.end),e.off(t+we.hover+Te.start),e.off(t+we.hover+Te.continue),e.off(t+we.hover+Te.end)}update(){this.observers_=this.observers_.filter((t=>null!=t)),ve.update();const t=this.scene.matter.add.circle(this.scene.input.mousePointer.x,this.scene.input.mousePointer.y,1,{circleRadius:1,isSensor:!0,render:{visible:!1}});for(const e of this.fingers){const i=ve.getLandmarkPosition(e.landmarkIndex),s=void 0!==i;if(s&&e.setPosition(i.x,i.y),ye(e,s),!s&&null!=t)for(const i of this.observers)null!=t&&null!=i.object&&i.object.active&&null!=this.scene&&(i.object.emit(e.name+we.pinch+Te.end),this.scene.matter.overlap(t,[i.object])||i.object.emit(e.name+we.hover+Te.end))}this.scene.matter.world.remove(t)}calculateHandDistance(t=0){const e=ve.getLandmarkPosition(5,t),i=ve.getLandmarkPosition(17,t),s=ve.getLandmarkPosition(0,t);let n=0,a=0;const o=innerWidth*innerHeight;if(void 0!==e&&void 0!==i){const t=new r((e.x+i.x)/2,(e.y+i.y)/2);n=Math.sqrt(Math.pow((i.x-e.x)/o,2)+Math.pow((i.y-e.y)/o,2)),void 0!==s&&(a=Math.sqrt(Math.pow((s.x-t.x)/o,2)+Math.pow((s.y-t.y)/o,2)))}return 0==n||0==a?0:8.2*.7/Math.max(n/8.2,a/10)/o*100}}const ke=new Set([[0,1],[0,5],[9,13],[13,17],[5,9],[0,17],[1,2],[2,3],[3,4],[5,6],[6,7],[7,8],[9,10],[10,11],[11,12],[13,14],[14,15],[15,16],[17,18],[18,19],[19,20]]);class Se extends p{constructor(t){super(t),this.bg=document.getElementById("background_image")}preload(){}create(t=oe.enableCameraVisibility,e=oe.cameraOpacity){ue.setVisibility(t),fe.setVisible(!1),document.getElementById("background_image"),this.bg.style.backgroundSize="cover",this.bg.style.opacity="1",this.clearBackgroundTint(),this.setOpacity(e),this.sound.pauseOnBlur=!1,this.graphics=this.add.graphics(),this.graphics.setDepth(99),this.hand=new xe(this)}update(t,e){this.graphics.clear(),this.hand.update(),function(t,e,i=0){t.setDepth(99),ve.forEachLandmarkPosition((i=>{t.lineStyle(e.lineWidth,e.color,e.alpha),t.strokeCircle(i.x,i.y,e.radius)}),i)}(this.graphics,et,0),function(t,e,i=0){t.setDepth(98),ke.forEach((s=>{const n=ve.getLandmarkPosition(s[0],i);if(void 0!==n){const a=ve.getLandmarkPosition(s[1],i);void 0!==a&&(t.lineStyle(e.lineWidth,e.color,e.alpha),t.lineBetween(n.x,n.y,a.x,a.y))}}))}(this.graphics,tt,0),fe.setDisplaySize(document.body.clientWidth,document.body.clientHeight+1)}setOpacity(t){if(null==t)return;Yt(t>=0&&t<=1);const e=1-t;fe.setAlpha(e),this.bg.style.opacity=e.toString()}setBackgroundTexture(t){fe.setTexture(t),this.bg.style.backgroundSize="0 0",fe.setVisible(!0)}setBackgroundTint(t){fe.setTint(t)}clearBackgroundTint(){fe.clearTint()}}class Pe extends v{constructor(t,e,i,s,n,a){super(t.matter.world,e.x,e.y,s,void 0,{render:{visible:!0},label:"button-"+s}),this.scene=t,this.scene.add.existing(this),this.sound=this.scene.sound.add(n,{volume:oe.sonificationLevel}),this.setSensor(!0),this.setOrigin(.5,.5),this.setScale(i.x,i.y),this.setDepth(93),ye(this,a),this.on("destroy",(()=>{this.scene.hand.removePinchCheck(nt,this)}))}removePinchCallbacks(){this.scene.hand.removePinchCheck(nt,this)}addPinchCallbacks(t){const e={startPinch:()=>{var e;null===(e=t.startPinch)||void 0===e||e.call(t),this.sound.play({volume:oe.sonificationLevel})},pinched:t.pinched,endPinch:t.endPinch,startHover:t.startHover,endHover:t.endHover};this.scene.hand.addPinchCheck(nt,this,e),this.on("pointerdown",e.startPinch),e.startHover&&this.on("pointermove",e.startHover),e.endHover&&this.on("pointerout",e.endHover)}}class Le{constructor(t){this.trackKey=Xt,this.bpm=0,this.beatLength_=1,this.trackKey=t}get beatLength(){return this.beatLength_}setBPM(t){Yt(null!=this.data,"preload JSON before setting BPM"),Yt(t<this.data.bpm.length,"BPM index out of range"),this.bpm=this.data.bpm[t];const e=16/this.data.timeSignatureDenominator;this.beatLength_=this.songTimePositionToTime({bar:1,step:1+e,tick:0})}getBPM(){return Yt(null!=this.data,"preload JSON before retrieving BPM"),Yt(0!=this.bpm,"Track BPM has not been set"),this.bpm}preload(t){this.preloadJson(t)}unload(t){this.unloadJson(t)}preloadNotes(t){Yt(null!=this.trackDir,"Preload track before preloading notes"),this.forEachLayer(void 0,(e=>{e.nodes.forEach(((i,s)=>{const n=this.getSoundKey(e,i.soundKey),a=this.trackDir+e.id+"/"+i.soundKey+b;t.cache.audio.exists(n)||""===i.soundKey||t.load.audio(n,ee(a))}))}))}unloadNotes(t){this.forEachLayer(void 0,(e=>{e.nodes.forEach(((i,s)=>{t.cache.audio.remove(this.getSoundKey(e,i.soundKey))}))}))}preloadLoops(t){this.forEachLayer((e=>{Yt(void 0!==e.soundLoopKeys),Yt(e.soundLoopKeys.length>0),e.soundLoopKeys.forEach((i=>{const s=this.getSoundKey(e,i),n=this.trackDir+e.id+"/"+i+b;t.cache.audio.exists(s)||""===i||t.load.audio(s,ee(n))}))}))}unloadLoops(t){this.forEachLayer((e=>{e.soundLoopKeys.forEach((i=>{t.cache.audio.remove(this.getSoundKey(e,i))}))}))}getSoundKey(t,e){return Yt(void 0!==e),this.trackKey+"/"+t.id+"/"+e}forEachLayer(t,e){Yt(null!=this.data,"JSON has not finished preloading");let i=0;this.data.layers.forEach(((s,n)=>{s.playable||i++,null==t||t(s,n),s.playable&&(null==e||e(s,n-i))}))}addBackgroundAudioTracks(t,e,i,s){const n=[];return this.forEachLayer(((a,o)=>{(null==s||s(a,o))&&(Yt(void 0!==a.soundLoopKeys),Yt(i<a.soundLoopKeys.length,"BPM index out of range of layer sound loop keys"),n.push(t.sound.add(this.getSoundKey(a,a.soundLoopKeys[i]),e)))})),n}timeToSongTimePosition(t){Yt(0!=this.bpm,"set BPM before retrieving song times");const e=t/(6e4/this.bpm),i=Math.floor(e/this.data.timeSignatureNumerator)+1,s=e%this.data.timeSignatureNumerator,n=4*s%1;return{bar:i,step:Math.floor(s*(4/this.data.timeSignatureDenominator)*4)+1,tick:Math.floor(n*(this.data.timeBasePPQ/4))}}songTimePositionToTime(t){return Yt(0!=this.bpm,"set BPM before retrieving song times"),((t.bar-1)*this.data.timeSignatureNumerator+(t.step-1)/(4/this.data.timeSignatureDenominator*4)+t.tick/this.data.timeBasePPQ)*(6e4/this.bpm)}preloadJson(t){const e=f+this.trackKey+"/";this.trackDir=e;const i=(e,i,s)=>{this.data=s,this.parseJson(),this.preloadLoops(t)};t.cache.json.exists(this.trackKey)?i(0,0,t.cache.json.get(this.trackKey)):(t.load.json(this.trackKey,ee(e+"info.json")),t.load.on("filecomplete-json-"+this.trackKey,i,this))}unloadJson(t){this.unloadLoops(t),t.cache.json.remove(this.trackKey)}parseJson(){this.setTimePositionDefaults(),this.sortNodes()}setTimePositionDefaults(){this.forEachLayer(void 0,(t=>{const e=(t,e,i,s)=>{t.bar||(t.bar=e),t.step||(t.step=i),t.tick||(t.tick=s)};Yt(t.progressCount<=t.nodes.length,"Progress count threshold for layer '"+t.id+"' of track '"+this.trackKey+"' cannot be higher than the node count."),e(t.previewTime,0,0,0),t.nodes.forEach((t=>{e(t.timePosition,1,1,0)}))}))}sortNodes(){this.forEachLayer(void 0,(t=>{t.nodes.sort(((t,e)=>t.timePosition.bar!==e.timePosition.bar?t.timePosition.bar-e.timePosition.bar:t.timePosition.step!==e.timePosition.step?t.timePosition.step-e.timePosition.step:t.timePosition.tick-e.timePosition.tick))}))}}class Ce extends v{static preload(t){t.load.image(rt,ee(lt)),t.load.image(ht,ee("assets/sprites/defaultTargetOuter.png"))}static unload(t){t.textures.remove(rt),t.textures.remove(ht)}constructor(t,e,i,s,n,a,o,r){super(t.matter.world,i.x,i.y,a.data.spriteKeyInner,void 0,{render:{visible:!0}}),this.scene=t,this.lifetime=s,this.fingerId=o,this.nodeIndex=r,this.spriteScale=oe.targetSize,this.scene.add.existing(this),this.songTime=this.lifetime+e,this.lateDuration=oe.lateTimeDuration,this.onTimeDuration=oe.onTimeDuration,this.earlyDuration=this.lifetime-this.onTimeDuration/2,this.sound=this.scene.sound.add(n,{volume:oe.sonificationLevel}),this.setScale(this.spriteScale),this.setTint(Y[this.fingerId]),this.setDepth(95),ye(this,!0),this.setCircle(this.displayWidth/2,{label:a.level.trackKey+"-"+a.data.id+"-node-"+r.toString()}),this.setSensor(!0),oe.fancyEffectsDisabled||(this.glow=this.postFX.addGlow(16777215,0,0,!1,.05,24)),this.outerRing=this.scene.add.sprite(i.x,i.y,a.data.spriteKeyOuter),this.outerRing.setScale(.5*this.spriteScale),this.outerRing.setDepth(96),this.targetText=new g(this.scene,0,0,Xt,{}),this.addTargetText(),this.setupTweens()}setOnTargetMiss(t){this.onTargetMiss=t}setOnTargetHit(t){this.scene.hand.addPinchCheck(this.fingerId,this,{startPinch:t}),this.once("pointerdown",t)}addTargetText(){this.targetText=this.scene.add.text(this.x,this.y,(this.nodeIndex+1).toString(),{font:"20px Arial",color:"white"}),this.targetText.setOrigin(.5,.5),this.targetText.setDepth(97)}createTween(t,e,i){for(const i of t)i.tint=e.color;return this.scene.tweens.add({targets:t,displayWidth:this.displayWidth*e.scale,displayHeight:this.displayHeight*e.scale,ease:e.ease,duration:i,repeat:0})}setupTweens(){oe.fancyEffectsDisabled||(this.rotateTween=this.scene.tweens.add({targets:[this],rotation:2*Math.PI,ease:"linear",duration:1e3,repeat:-1})),this.earlyTween=this.createTween([this.outerRing],ct,this.earlyDuration),this.earlyTween.on("complete",(()=>{this.onTimeTween=this.createTween([this],Object.assign(Object.assign({},dt),{scale:1}),this.onTimeDuration),oe.fancyEffectsDisabled||null==this.glow||(this.glowTween=this.scene.tweens.add({targets:this.glow,outerStrength:4,yoyo:!0,duration:this.onTimeDuration/2,ease:"linear"})),this.onTimeTween.on("complete",(()=>{null!=this.glow&&this.glow.destroy(),this.lateTween=this.createTween([this,this.outerRing],Object.assign(Object.assign({},ut),{scale:1}),this.lateDuration),this.lateTween.on("complete",(()=>{ye(this,!1),this.deathTween=this.createTween([this,this.outerRing,this.targetText],gt,400),null!=this.onTargetMiss&&this.deathTween.on("complete",this.onTargetMiss)}))}))}))}destroyTarget(){this.scene.hand.removePinchCheck(this.fingerId,this),this.off("pointerdown"),null!=this.rotateTween&&this.scene.tweens.remove(this.rotateTween),null!=this.earlyTween&&this.scene.tweens.remove(this.earlyTween),null!=this.onTimeTween&&this.scene.tweens.remove(this.onTimeTween),null!=this.lateTween&&this.scene.tweens.remove(this.lateTween),null!=this.deathTween&&this.scene.tweens.remove(this.deathTween),null!=this.glowTween&&this.scene.tweens.remove(this.glowTween),null!=this.glow&&this.glow.destroy(),null!=this.targetText&&this.targetText.destroy(),this.outerRing.destroy(),this.destroy()}}class Be extends d{constructor(t){super(t,"metronome"),this.beat=0,this.timer=new c({}),this.countdownText=this.scene.add.text(xt.position.x,xt.position.y,Xt,{font:xt.font,color:xt.color}).setOrigin(.5,.5).setScale(xt.scale).setDepth(xt.depth),this.setVisible(!1)}preload(){this.scene.load.image(Tt,ee("assets/sprites/countdown.png")),this.scene.load.audio(wt.highKey,ee(wt.highPath)),this.scene.load.audio(wt.lowKey,ee(wt.lowPath))}unload(){this.scene.cache.audio.remove(wt.highKey),this.scene.cache.audio.remove(wt.lowKey)}setup(){this.countdownTexture=this.scene.add.sprite(xt.position.x,xt.position.y,Tt).setScale(1).setVisible(!1).setOrigin(.5,.5).setAlpha(.3).setDepth(30)}setVisible(t){null!=this.countdownText&&this.countdownText.setVisible(t),null!=this.countdownTexture&&this.countdownTexture.setVisible(t)}stop(){this.setVisible(!1),null!=this.scene&&(this.scene.time.removeEvent(this.timer),this.scene.sound.stopByKey(wt.highKey),this.scene.sound.stopByKey(wt.lowKey),null!=this.shrinkTween&&this.scene.tweens.remove(this.shrinkTween))}play(t,e,i){this.beat=0,this.stop(),this.timer=this.scene.time.addEvent({callback:this.tick.bind(this,t,e,i),delay:e,loop:!0,startAt:e})}tick(t,e,i){Yt(i>=1,"Cannot display metronome for less than minimum bar count");const s=t*i,n=this.beat%t,a=0==n?wt.highKey:wt.lowKey;this.beat>=s?this.setVisible(!1):(this.countdownText.active&&this.scene.sound.play(a,{volume:oe.backgroundMusicLevel}),Yt(s-t>=0),this.beat>=s-t&&this.countdownText.active&&!oe.disableVisualMetronome&&this.display(n+1,e),this.beat++)}display(t,e){this.countdownText.setText(t.toString()),this.countdownText.setScale(xt.scale),this.countdownTexture.setScale(1),this.setVisible(!0),this.shrinkTween=this.scene.tweens.add({targets:[this.countdownText,this.countdownTexture],ease:xt.ease,duration:.9*e,scale:0,repeat:0})}}class De extends h{constructor(t){super(t),this.current_=0,this.requiredProgress=-1,this.nodeCount=1,this.tints=[],Yt(this.current_>=0),this.tints=[],this.scene.add.existing(this),this.setVisible(!1)}preload(){this.scene.load.image(bt.key,ee(bt.path))}setup(t,e,i,s){Yt(i<=e),Yt(s.length===e,"Must pass tints equal in number to nodes"),Yt(e>0),Yt(i>0),Yt(t>=0),this.current_=t,this.nodeCount=e,this.tints=s,this.requiredProgress=i;const n=bt.size.x/this.nodeCount;this.clear(),this.createMultiple({quantity:this.nodeCount,key:bt.key,visible:!0,setXY:{x:bt.position.x-bt.size.x/2+n/2,y:bt.position.y+bt.size.y/2,stepX:n}}),this.propertyValueSet("displayWidth",n),this.propertyValueSet("displayHeight",bt.size.y),this.setDepth(61),this.redraw()}setToStarting(){this.current_=0,Yt(this.current_>=0),this.redraw()}redraw(){if(this.current<=this.nodeCount){this.getChildren().forEach(((t,e)=>{t.clearTint()}));const t=-1===this.requiredProgress?this.nodeCount:this.requiredProgress-1,e=this.current;this.getChildren().forEach(((i,s)=>{const n=i;bt.tintByNode&&n.setTint(this.tints[s]),s<e&&(s<=t?n.setTint(bt.completedTint):n.setTint(bt.extraTint)),s===t&&(e>t?n.setTint(bt.completedRequiredTint):n.setTint(bt.requiredTint))}),this)}}canProgress(){const t=-1===this.requiredProgress;return t&&this.current>=this.nodeCount||!t&&this.current>=this.requiredProgress}changeBy(t){this.current_=Math.max(0,Math.min(this.current+t,this.nodeCount))}get current(){return this.current_}}class Oe extends d{constructor(t,e){super(t,"infoHUD"),this.scene=t,this.level=e}setup(){this.addTexts(),this.addSkipButton(),this.setVisible(!1)}addSkipButton(){this.skipButton=new Pe(this.scene,St.position,St.scale,St.textureKey,St.soundKey,!1),this.skipButton.addPinchCallbacks({startPinch:()=>{ye(this.skipButton,!1),this.level.transitionLayers()},startHover:()=>{this.skipButton.setTintFill(at)},endHover:()=>{this.skipButton.clearTint()}}),this.updateSkipButtonAvailability(!1)}preload(){this.scene.load.image(St.textureKey,ee(St.path)),this.scene.load.image(kt.textureKey,ee(kt.path))}setVisible(t){null!=this.trackText&&this.trackText.setVisible(t),null!=this.difficultyText&&this.difficultyText.setVisible(t),null!=this.bpmText&&this.bpmText.setVisible(t),null!=this.layerText&&this.layerText.setVisible(t),null!=this.loopText&&this.loopText.setVisible(t),null!=this.infoBackground&&this.infoBackground.setVisible(t),this.updateSkipButtonAvailability(t)}addText(t,e){return this.scene.add.text(t.position.x,t.position.y,e,{font:t.font,color:t.color}).setScale(t.scale).setDepth(t.depth)}getLoopText(){return"Loop: "+this.level.score.getLoopCount().toString()}addTexts(){this.loopText=this.addText(Dt,this.getLoopText());const t="Track: "+this.level.track.data.displayName;this.trackText=this.addText(Pt,t);const e="Layer: "+(this.level.activeLayerIndex+1).toString()+"/"+this.level.playableLayers.length.toString();let i=Xt;switch(this.level.bpmIndex){case 0:i="Easy";break;case 1:i="Medium";break;case 2:i="Hard"}Yt(i!=Xt,"Extend the switch statement to have a difficulty text for the given track bpmIndex"),this.difficultyText=this.addText(Lt,"Difficulty: "+i),this.bpmText=this.addText(Ct,"BPM: "+this.level.track.getBPM()),this.layerText=this.addText(Bt,e),this.infoBackground=this.scene.add.sprite(kt.position.x,kt.position.y,kt.textureKey).setAlpha(kt.opacity).setOrigin(0,0).setDisplaySize(kt.size.x,kt.size.y)}updateLoopText(){this.loopText.setText(this.getLoopText()),this.updateSkipButtonAvailability(!0)}updateSkipButtonAvailability(t){const e=oe.enableSkipButton&&this.level.score.getLoopCount()>=oe.skipLoopThreshold&&t;null!=this.skipButton&&ye(this.skipButton,e)}}class He{constructor(){this.targets=[]}start(){this.destroyTargets()}destroyTarget(t){t.destroyTarget();const e=this.targets.indexOf(t,0);e>-1&&this.targets.splice(e,1)}destroyTargets(){const t=[...this.targets];for(const e of t)this.destroyTarget(e)}addTarget(t){this.targets.push(t)}getPreviousTargets(t){return this.targets.filter((e=>e.songTime<t.songTime))}}class _e{constructor(t,e){this.level=t,this.data=e}getDuration(){return this.level.track.songTimePositionToTime({bar:this.data.lengthInBars+1,step:1,tick:0})}}class Ie extends _e{constructor(t,e,i){super(e,i),this.nextNodeIndex=0,this.songTime_=0,this.oldTimePosition=0,this.startTime=0,this.time=0,this.ready=!1,this.scene=t,this.data=i,this.metronome=new Be(this.scene),this.progress=new De(this.scene),this.infoHud=new Oe(this.scene,this.level),this.targetManager=new He}get songTime(){return this.songTime_}preload(){this.infoHud.preload(),this.metronome.preload(),this.progress.preload()}unload(){this.metronome.unload(),this.infoHud.destroy()}start(t){this.targetManager.start(),this.level.score.delay=t,this.ready=!0,this.startTime=this.time+t,this.nextNodeIndex=0,this.oldTimePosition=0;const e=Math.max(this.data.previewTime.bar,1),i=[];this.data.nodes.forEach(((t,e)=>{const s=oe.indexFingerOnly?st:t.finger;i.push(Y[s])})),this.progress.setup(0,this.data.nodes.length,this.data.progressCount,i),this.metronome.setup(),this.infoHud.setup(),this.progress.setVisible(!0),this.infoHud.setVisible(!0),this.metronome.play(this.level.track.data.timeSignatureNumerator,this.level.track.beatLength,e)}createTarget(t,e,i){const s=oe.indexFingerOnly?st:t.finger,n=new Ce(this.scene,this.songTime_,se(t.normalizedPosition),this.getPreviewTime(),this.level.track.getSoundKey(this.data,t.soundKey),this,s,i);n.setOnTargetMiss((()=>{this.level.score.missedPinch(n),this.progress.changeBy(-1),this.progress.redraw(),this.level.streak.stop(),this.targetManager.destroyTarget(n),this.checkForTransition(e,i)})),n.setOnTargetHit((()=>{const t=this.targetManager.getPreviousTargets(n);for(const i of t)Yt(i!=n),this.progress.changeBy(-1),this.level.score.skippedPinch(i),this.checkForTransition(e,i.nodeIndex),this.targetManager.destroyTarget(i);t.length>0&&this.level.streak.stop();const s=this.songTime-n.songTime,a=n.onTimeDuration/2,o=s>a;s<-a?(this.level.streak.stop(),this.progress.changeBy(0),this.level.score.earlyPinch(n,this.songTime)):o?(this.level.streak.stop(),this.progress.changeBy(0),this.level.score.latePinch(n,this.songTime)):(this.level.streak.changeBy(1),this.progress.changeBy(1),this.level.score.onTimePinch(n,this.songTime,this.level.streak.current)),this.progress.redraw(),this.level.streak.check(),oe.disableSonification||n.sound.play({volume:oe.sonificationLevel}),this.targetManager.destroyTarget(n),this.checkForTransition(e,i)})),this.targetManager.addTarget(n)}checkForTransition(t,e){e==this.data.nodes.length-1&&this.level.activeLayerIndex==t&&(oe.enableAutoSkip&&this.level.score.getLoopCount()>=oe.autoSkipThreshold||this.progress.canProgress()&&!oe.disableLayerProgression?this.level.transitionLayers():(this.level.score.incrementLoopCount(),this.progress.setToStarting(),this.infoHud.updateLoopText(),oe.autoSaveCSV&&ce(this.level.score.levelStats)))}handleTargetCreation(){if(!this.ready)return;const t=this.getDuration();let e=this.songTime_+this.getPreviewTime();if(this.songTime_>0&&(e%=t),this.data.nodes.length<=this.nextNodeIndex){if(!(e<this.oldTimePosition))return;this.nextNodeIndex=0}const i=this.data.nodes[this.nextNodeIndex];this.level.track.songTimePositionToTime(i.timePosition)%t<=e&&(void 0!==i.finger&&this.createTarget(i,this.level.activeLayerIndex,this.nextNodeIndex),this.nextNodeIndex++),this.oldTimePosition=e}preDelayStop(){this.ready=!1,this.metronome.stop(),this.targetManager.destroyTargets()}postDelayStop(){this.infoHud.setVisible(!1),this.progress.setVisible(!1)}stop(){this.preDelayStop(),this.postDelayStop()}update(t){this.time=t,this.songTime_=this.ready?this.time-this.startTime:0,this.handleTargetCreation()}getPreviewTime(){return this.level.track.songTimePositionToTime({bar:this.data.previewTime.bar+1,step:this.data.previewTime.step+1,tick:this.data.previewTime.tick})}}class Me extends d{constructor(t){super(t,"streak"),this.current_=0,this.onFire=!1,this.hsv=Phaser.Display.Color.HSVColorWheel(),this.streakText=this.scene.add.text(mt.position.x,mt.position.y,Xt,{font:mt.font,color:mt.color}).setVisible(!1).setOrigin(.5,.5).setScale(mt.scale).setDepth(mt.depth).setStroke(mt.color,mt.strokeThickness).setShadow(mt.shadowOffset.x,mt.shadowOffset.y,mt.shadowColor,mt.shadowBlurRadius,!0,!0)}preload(){this.scene.load.image(yt,ee("assets/sprites/flare.png"))}unload(){this.scene.textures.remove(yt)}get current(){return this.current_}changeBy(t){this.current_=Math.max(0,this.current+t)}check(){1===this.current_?this.start():this.current_>1?this.continue():this.stop()}updateStreakText(){this.streakText.setText("Streak: "+this.current_.toString())}start(){this.updateStreakText(),this.streakText.setVisible(!0)}stop(){this.current_=0,this.onFire=!1,null!=this.onFireTween&&this.scene.tweens.remove(this.onFireTween),null!=this.streakText&&this.streakText.clearTint(),null!=this.streakText&&this.streakText.setVisible(!1),null!=this.flame&&this.flame.destroy()}continue(){this.updateStreakText();const t=this.onFire;this.onFire=this.current_>=2,!t&&this.onFire&&(Yt(!0,"Streak color wheel extent must be from 1 to 255"),this.onFireTween=this.scene.tweens.addCounter({from:0,to:30,duration:1e3,yoyo:!0,onUpdate:t=>{if(null!=this&&null!=this.hsv){const e=Math.floor(t.getValue()),i=this.hsv[e].color,s=this.hsv[30-e].color;null!=this.streakText&&this.streakText.setTint(i,i,s,s)}},onStop:()=>{null!=this.onFireTween&&this.scene.tweens.remove(this.onFireTween)}}),oe.fancyEffectsDisabled||(null!=this.flame&&this.flame.destroy(),null!=this.streakText&&(this.flame=this.scene.add.particles(this.streakText.x,this.streakText.y,yt,ft),Yt(0!=mt.depth),this.flame.setDepth(mt.depth-1))))}}class Ve{constructor(){this.total=1,this.required=1,this.correct=0,this.early=0,this.late=0,this.miss=0,this.loop=1,this.hits=[]}}class Ae{constructor(t){this.maxStreak=0,this.layersStats=[],this.id=`${t.data.displayName.replace(/\s/g,"")}@${t.getBPM()}bpm_${(new Date).toLocaleString("en-GB").replace(/\s/g,"").replace(/,/g,"_").replace(/[:/]/g,"-")}`}}class Ee{constructor(t){this.levelStats=new Ae(t),this.layerStats=new Ve}getLoopCount(){return this.layerStats.loop}incrementLoopCount(){this.layerStats.correct=0,this.layerStats.early=0,this.layerStats.late=0,this.layerStats.miss=0,this.layerStats.loop++}saveLayerScores(){this.levelStats.layersStats.push(this.layerStats)}resetLayerScores(t,e){this.layerStats=new Ve,this.layerStats.total=t,this.layerStats.required=e}addHit(t,e,i){this.layerStats.hits.push({loopNumber:this.getLoopCount(),noteID:t.nodeIndex+1,correctTime:t.songTime+this.delay,playerTime:e,classification:i})}onTimePinch(t,e,i){this.addHit(t,e+this.delay,"correct"),this.layerStats.correct++,this.levelStats.maxStreak=Math.max(i,this.levelStats.maxStreak)}earlyPinch(t,e){this.addHit(t,e+this.delay,"early"),this.layerStats.early++}latePinch(t,e){this.addHit(t,e+this.delay,"late"),this.layerStats.late++}skippedPinch(t){this.addHit(t,-1e3,"skipped"),this.layerStats.miss++}missedPinch(t){this.addHit(t,-1e3,"missed"),this.layerStats.miss++}}class Ke{constructor(t){this.trackKey_=Xt,this.finishCallback=()=>{},this.abortCallback=()=>{},this.activeLayerIndex=0,this.playableLayers=[],this.activeAudioTracks=[],this.bpmIndex_=-1,this.trackKey_=t,this.track=new Le(this.trackKey_)}setBPM(t){Yt(-1!=t,"BPM must be set before starting the level"),this.track.setBPM(t),this.bpmIndex_=t}get bpmIndex(){return this.bpmIndex_}get trackKey(){return this.trackKey_}init(t){this.scene=t,this.streak=new Me(this.scene),this.score=new Ee(this.track),this.preloadLayers()}hasCustomBackground(){return ie(f+this.getBackgroundTextureKey())}hasPreviewVideo(){return ie(f+this.getPreviewVideoKey())}getBackgroundTextureKey(){return this.trackKey+"/background.png"}getPreviewVideoKey(){return this.trackKey+"/preview.mp4"}preloadTrack(t){const e=f+this.getPreviewVideoKey(),i=f+this.getBackgroundTextureKey();ie(e)&&t.load.video(this.getPreviewVideoKey(),ee(e),!0),ie(i)&&t.load.image(this.getBackgroundTextureKey(),ee(i)),this.track.preload(t)}unloadTrack(t){this.track.unload(t)}preloadLayers(){this.track.preloadNotes(this.scene),Ce.preload(this.scene),this.streak.preload(),this.playableLayers=[],this.track.forEachLayer(void 0,((t,e)=>{const i=new Ie(this.scene,this,t);i.preload(),this.playableLayers.push(i)}))}unloadLayers(){this.playableLayers.forEach((t=>{t.unload()})),this.track.unloadNotes(this.scene),Ce.unload(this.scene),this.streak.unload()}start(t,e){this.activeLayerIndex=0,this.removeBackgroundAudio(this.scene),this.playableLayers.forEach((t=>{t.stop()})),this.streak.stop(),this.setBPM(this.bpmIndex_),this.finishCallback=t,this.abortCallback=e,this.scene.time.delayedCall(1e3,(()=>{this.startLayer()}))}addBackgroundAudio(t,e,i){Yt(-1!=this.bpmIndex_,"Set BPM before adding background audio to level"),this.removeBackgroundAudio(t),this.activeAudioTracks=this.track.addBackgroundAudioTracks(t,e,this.bpmIndex_,i)}removeBackgroundAudio(t){this.activeAudioTracks.forEach((e=>{e.stop(),t.sound.remove(e)})),this.activeAudioTracks=[]}playBackgroundAudio(){this.activeAudioTracks.forEach((t=>{t.setMute(!1),t.play()}))}setBackgroundAudioMute(t){this.activeAudioTracks.forEach((e=>{e.setMute(t)}))}startLayer(){const t=this.getActiveLayer(),e=this.activeLayerIndex;this.score.resetLayerScores(t.data.nodes.length,t.data.progressCount);const i=this.track.songTimePositionToTime({bar:2,step:1,tick:0}),s=Math.max(i,t.getPreviewTime());t.start(s);const n=[...t.data.backgroundLayers];oe.disableSonification&&n.push(t.data.id),this.addBackgroundAudio(this.scene,{loop:!0,volume:oe.backgroundMusicLevel},((t,e)=>n.includes(t.id))),this.scene.time.delayedCall(s,(()=>{this.activeLayerIndex==e&&this.playBackgroundAudio()}))}getActiveLayer(){return Yt(this.activeLayerIndex<this.playableLayers.length,"Active layer index cannot exceed number of playable layers"),this.playableLayers[this.activeLayerIndex]}transitionLayers(){if(oe.autoSaveCSV&&ce(this.score.levelStats),this.activeLayerIndex<this.playableLayers.length){const t=this.getActiveLayer();t.preDelayStop(),this.removeBackgroundAudio(this.scene),this.activeLayerIndex++;const e=this.activeLayerIndex;if(this.activeLayerIndex>=this.playableLayers.length)return this.score.saveLayerScores(),t.postDelayStop(),void this.end();this.scene.time.delayedCall(1e3,(()=>{this.activeLayerIndex==e&&(this.score.saveLayerScores(),t.postDelayStop(),this.startLayer())}))}}stop(){this.removeBackgroundAudio(this.scene),this.streak.stop(),this.unloadLayers()}end(){this.stop(),this.finishCallback()}abort(){oe.autoSaveCSV&&(this.score.saveLayerScores(),ce(this.score.levelStats)),this.stop(),this.abortCallback()}update(t){this.activeLayerIndex<this.playableLayers.length&&this.getActiveLayer().update(t)}getAudioLoopTime(){return this.activeAudioTracks.at(-1).duration}}class Fe extends Pe{constructor(t,e,i,s,n,a,o,r=!0){super(t,e,i,s,a,o),this.onSpriteKey=s,this.offSpriteKey=n,this.toggleState=r,this.setTexture(this.getSpriteKey())}setToggleState(t){var e;this.toggleState=t,this.setTexture(this.getSpriteKey()),null===(e=this.toggleCallback)||void 0===e||e.call(this,this.toggleState)}addToggleCallback(t){this.toggleCallback=t,this.toggleCallback(this.toggleState)}toggle(){var t;this.toggleState=!this.toggleState,this.setTexture(this.getSpriteKey()),null===(t=this.toggleCallback)||void 0===t||t.call(this,this.toggleState)}getToggleState(){return this.toggleState}updateTint(){this.toggleState?this.setTintFill(ot):this.clearTint()}getSpriteKey(){return this.toggleState?this.onSpriteKey:this.offSpriteKey}}class je extends Fe{constructor(t,e,i,s,n,a,o,r,h,l=!0){super(t,e,i,s,n,a,o,l),this.bpmTextOptions={font:"20px Courier New",color:16777215},this.bpmIndex_=r,this.bpm=h,this.bpmText=this.scene.add.text(0,0,Xt,{font:this.bpmTextOptions.font}),this.bpmText.setText("BPM: "+this.bpm.toString()),this.bpmText.setPosition(e.x-this.bpmText.displayWidth/2,e.y-this.bpmText.displayHeight/2+.023*window.innerHeight),this.updateTint(),this.on("destroy",(()=>{this.bpmText.destroy()}))}updateTint(){this.toggleState?(this.bpmText.setTintFill(ot),this.setTintFill(ot)):(this.bpmText.setTintFill(this.bpmTextOptions.color),this.clearTint())}get bpmIndex(){return this.bpmIndex_}}var Ne=n().Math.Vector2,ze=n().Math.RoundTo;class Re extends l{constructor(t,e,i,s,n,a,o,r){super(t),this.isDragging=!1,this.range=new Ne(0,1),this.isInteger=!1,this.x=e.x,this.y=e.y,this.width=i.x,this.height=i.y,this.key=a,this.updateSliderCallback=r,this.range=o,this.value=.5,this.box=new u(0,0,i.x,i.y),this.handle=new u(0,0,i.y,i.y),this.updateHandle(),null!=s&&(this.label=this.scene.add.text(this.x+s.x,this.y+s.y,Xt,{color:"#ffffff",fontSize:"24px"})),this.setInteractive(this.box,u.Contains),this.on("pointerdown",this.startDrag,this),this.scene.input.on("pointerup",this.stopDrag,this),this.scene.input.on("pointermove",this.doDrag,this),Yt("number"==typeof n[this.key]),this.setValue(n[this.key]),this.draw()}reset(t){Yt("number"==typeof t[this.key]),this.setValue(t[this.key]),this.draw()}startDrag(){this.isDragging=!0}doDrag(t){this.isDragging&&(this.value=n().Math.Clamp((t.x-this.x-this.handle.width/2)/(this.width-this.handle.width),0,1),this.updateHandle(),this.draw())}stopDrag(){this.isDragging=!1}updateHandle(){this.handle.x=this.value*(this.width-this.handle.width)}draw(){this.clear(),null!=this.input&&(this.input.enabled||this.setInteractive(this.box,u.Contains),this.updateSliderCallback(this)),this.fillStyle(11184810),this.fillRectShape(this.box),this.fillStyle(16777215),this.fillRectShape(this.handle)}getStringValue(){const t=this.getValue();return this.isInteger?t.toFixed(0):t.toFixed(2)}getValue(){const t=this.value*(this.range.y-this.range.x)+this.range.x;return this.isInteger?ze(t,0):t}setIsInteger(t){return this.isInteger=t,this.draw(),this}setValue(t){this.value=(t-this.range.x)/(this.range.y-this.range.x),this.updateHandle(),this.draw()}hide(t){return this.clear(),null!=this.input&&this.disableInteractive(),null!=this.label&&null!=this.label&&this.label.active&&(null!=t?this.label.setText(t):this.label.setText("")),this}}class We extends l{constructor(t,e,i,s,n,a,o,r){super(t),this.labelText=Xt,this.x=e.x,this.y=e.y,this.key=o,null!=s&&(this.labelText=n,this.label=this.scene.add.text(e.x+s.x,e.y+s.y,this.labelText,{color:"#ffffff",fontSize:"24px"})),this.toggleCallback=r,Yt("boolean"==typeof a[this.key]),this.isChecked_=a[this.key],this.box=new u(0,0,i,i),this.check=new u(.25*i,.25*i,.5*i,.5*i),this.setInteractive(this.box,u.Contains),this.toggleCallback(this),this.on("pointerdown",this.toggleCheck,this),this.draw()}reset(t){Yt("boolean"==typeof t[this.key]),this.isChecked_=t[this.key],this.toggleCallback(this),this.draw()}resetLabel(){null!=this.label&&this.label.setText(this.labelText)}setLabel(t){null!=this.label&&this.label.setText(t),this.draw()}toggleCheck(){this.isChecked_=!this.isChecked_,this.toggleCallback(this),this.draw()}draw(){this.clear(),null==this.input||this.input.enabled||this.setInteractive(this.box,u.Contains),this.lineStyle(2,16777215),this.strokeRectShape(this.box),this.isChecked_&&(this.fillStyle(16777215),this.fillRectShape(this.check))}setToggled(t){"boolean"==typeof t&&(this.isChecked_=t,this.toggleCallback(this),this.draw())}hide(){return this.clear(),this.disableInteractive(),null!=this.label&&this.label.setText(""),this}get isChecked(){return this.isChecked_}}var qe=function(t,e,i,s){return new(i||(i=Promise))((function(n,a){function o(t){try{h(s.next(t))}catch(t){a(t)}}function r(t){try{h(s.throw(t))}catch(t){a(t)}}function h(t){var e;t.done?n(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(o,r)}h((s=s.apply(t,e||[])).next())}))};const $e=window.innerWidth,Ge=window.innerHeight,Je=.5*$e,Ue=.1*$e,Xe=.64*$e,Ze=.1*Ge,Qe=.08*Ge,Ye=.32*Ge,ti=.08*Ge,ei=.57*Ge,ii=.08*Ge,si=new r(.26*$e,.03*Ge);var ni=i(223),ai=i(434),oi=i(769),ri=function(t,e,i,s){return new(i||(i=Promise))((function(n,a){function o(t){try{h(s.next(t))}catch(t){a(t)}}function r(t){try{h(s.throw(t))}catch(t){a(t)}}function h(t){var e;t.done?n(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(o,r)}h((s=s.apply(t,e||[])).next())}))};let hi=null;const li={type:n().WEBGL,scale:{mode:n().Scale.RESIZE},transparent:!0,physics:{default:"matter",matter:{debug:!1,gravity:{x:0,y:0}}},scene:[class extends p{constructor(){super("electron")}create(){return me(this,void 0,void 0,(function*(){yield new Promise(((t,e)=>{t()})).then((()=>{this.scene.start(Ft)}))}))}},class extends p{constructor(){super(Ft)}preload(){this.load.image(T,ee("assets/sprites/finger.png")),this.load.image(H,ee("assets/ui/menu_background.png"))}create(){return me(this,void 0,void 0,(function*(){fe=this.add.sprite(0,0,H).setOrigin(0,0).setVisible(!1),fe.displayWidth=window.innerWidth,fe.displayHeight=window.innerWidth*fe.height/fe.width;const t=this.add.text(this.cameras.main.worldView.x+this.cameras.main.width/2,this.cameras.main.worldView.y+this.cameras.main.height/2,"",vt).setShadow(1,1).setDepth(1e3).setOrigin(.5);yield ue.init(Gt,this.updateText.bind(this,t)).catch((e=>{this.updateText(t,e)})),ue.found()&&(this.updateText(t,"Loading config data..."),yield le(Q).catch((e=>this.updateText(t,e))),yield le("data/default_config.json").then((t=>{re=t})).catch((e=>this.updateText(t,e))),yield ve.init(this.updateText.bind(this,t)).catch((e=>this.updateText(t,e))),ve.found()&&(ue.setVisibility(Gt.visible),this.scene.launch($t),ve.precache(this.updateText.bind(this,t)),this.updateText(t,"Loading game..."),this.scene.get($t).load.on("complete",(()=>{t.destroy()}))))}))}updateText(t,e){console.info("INFO: "+e);let i=e;e instanceof DOMException&&(i="NotFoundError"==e.name?"Webcam not found":"PermissionError"==e.name?"Permission denied":"NotADirectoryError"==e.name?e.message:e.name+": "+e.message),t.setText(i)}},class extends Se{constructor(){super(zt),this.levels=[]}preload(){const t=Object.create(null,{preload:{get:()=>super.preload}});return e=this,i=void 0,n=function*(){t.preload.call(this),this.load.audio(E,ee(w)),this.load.image(F,ee("assets/ui/menu_logo.png")),this.load.image(B,ee("assets/ui/menu_options.png")),this.load.image(C,ee("assets/ui/menu_select_level.png")),this.load.image(L,ee("assets/ui/menu_setup_camera.png")),yield function(t){return new Promise(((e,i)=>Zt(this,void 0,void 0,(function*(){yield Qt(ee(t)).then((t=>{e(t)})).catch((()=>{i([])}))}))))}(ee(y)).then((t=>{t.forEach(((t,e)=>{this.levels.push(new Ke(t))})),this.levels.forEach((t=>{t.preloadTrack(this)}))}))},new((s=void 0)||(s=Promise))((function(t,a){function o(t){try{h(n.next(t))}catch(t){a(t)}}function r(t){try{h(n.throw(t))}catch(t){a(t)}}function h(e){var i;e.done?t(e.value):(i=e.value,i instanceof s?i:new s((function(t){t(i)}))).then(o,r)}h((n=n.apply(e,i||[])).next())}));var e,i,s,n}create(){super.create(),this.levels.forEach((t=>{t.setBPM(0)}));const t=window.innerWidth,e=window.innerHeight,i=.5*t;this.menuCalibrate=new Pe(this,new r(i-.25*t,Kt*e),_t,L,E,!0),this.levels.length>0&&(this.menuSelectLevel=new Pe(this,new r(i,Kt*e),_t,C,E,!0),this.menuSelectLevel.addPinchCallbacks({startPinch:()=>{this.scene.start(Rt,this.levels)},startHover:()=>{this.menuSelectLevel.setTintFill(at)},endHover:()=>{this.menuSelectLevel.clearTint()}})),this.menuOptions=new Pe(this,new r(i+.25*t,Kt*e),_t,B,E,!0),this.menuLogo=this.add.sprite(0,0,F).setOrigin(0,0).setScale(.7,.7),this.menuLogo.setPosition(i-this.menuLogo.displayWidth/2,.25*e),this.menuCalibrate.addPinchCallbacks({startPinch:()=>{this.scene.start(Wt)},startHover:()=>{this.menuCalibrate.setTintFill(at)},endHover:()=>{this.menuCalibrate.clearTint()}}),this.menuOptions.addPinchCallbacks({startPinch:()=>{this.scene.start(qt)},startHover:()=>{this.menuOptions.setTintFill(at)},endHover:()=>{this.menuOptions.clearTint()}})}update(t,e){super.update(t,e)}},class extends Se{constructor(){super(qt),this.options=[]}setConfig(){var t;t=this.configData,ee(Q),JSON.stringify(t),he(t),ue.setVisibility(this.configData.enableCameraVisibility)}saveAndExit(){this.setConfig(),null!=this.rotateTween&&this.rotateTween.destroy(),this.scene.start(zt)}preload(){return qe(this,void 0,void 0,(function*(){this.load.audio(E,ee(w)),this.load.image(O,ee("assets/ui/options_background.png")),this.load.image(A,ee(U)),this.load.image(j,ee("assets/ui/reset_button.png")),this.load.image(D,ee(J))}))}create(){const t=Object.create(null,{create:{get:()=>super.create}});return qe(this,void 0,void 0,(function*(){t.create.call(this),this.defaultData=re,this.configData=oe,this.createOptions()}))}createOptions(){this.backToMenu=new Pe(this,new r(Je-.1*$e,.9*Ge),_t,A,E,!0),this.resetConfig=new Pe(this,new r(Je+.1*$e,.9*Ge),_t,j,E,!0),this.input.keyboard.on(pt,(()=>{this.saveAndExit()})),this.add.sprite(.09*$e,.05*Ge,O).setOrigin(0,0).setAlpha(.8).setDisplaySize(.28*$e,.185*Ge),this.add.sprite(.09*$e,.26*Ge,O).setOrigin(0,0).setAlpha(.8).setDisplaySize(.28*$e,.27*Ge),this.add.sprite(.09*$e,.55*Ge,O).setOrigin(0,0).setAlpha(.8).setDisplaySize(.28*$e,.23*Ge),this.add.sprite(.63*$e,.05*Ge,O).setOrigin(0,0).setAlpha(.8).setDisplaySize(.28*$e,.185*Ge),this.add.sprite(.63*$e,.26*Ge,O).setOrigin(0,0).setAlpha(.8).setDisplaySize(.28*$e,.27*Ge),this.add.sprite(.63*$e,.55*Ge,O).setOrigin(0,0).setAlpha(.8).setDisplaySize(.28*$e,.23*Ge);const t=this.add.sprite(.5*$e,Ze+0*Qe+.15*Ge,D).setTint(Y[it]).setScale(this.configData.targetSize);this.rotateTween=this.tweens.add({targets:[t],rotation:2*Math.PI,ease:"Power0",duration:1e3,repeat:-1}),this.configData.fancyEffectsDisabled&&null!=this.rotateTween&&this.rotateTween.pause();const e=new Re(this,new r(Ue,Ze+0*Qe),si,new r(0,Vt.y),this.configData,"targetSize",new r(.5,3),(e=>{e.label.setText("Target Scale: "+e.getStringValue());const i=e.getValue();this.configData[e.key]=i,t.setScale(i)}));this.options.push(e),this.add.existing(e);const i=new Re(this,new r(Ue,Ze+1*Qe),si,new r(0,Vt.y),this.configData,"fingerSize",new r(.5,3),(t=>{null!=t.label&&t.label.setText("Finger Scale: "+t.getStringValue());const e=t.getValue();this.configData[t.key]=e,this.hand.setFingerScale(e)}));this.options.push(i),this.add.existing(i);const s=t=>{null!=t&&t.active&&(null!=t.label&&t.label.active&&t.label.setText("Camera Opacity: "+t.getStringValue()),this.configData[t.key]=t.getValue(),this.setOpacity(this.configData[t.key]))},n=new Re(this,new r(Ue,Ye+0*ti),si,Vt,this.configData,"cameraOpacity",new r(.01,1),s),a=new We(this,new r(Ue,Ye+0*ti+Mt.y),25,void 0,Xt,this.configData,"enableCameraVisibility",(t=>{this.configData[t.key]=t.isChecked,ue.setVisibility(t.isChecked),t.isChecked?n.draw():(n.setValue(this.configData.cameraOpacity),s(n),this.setOpacity(0),n.hide("Show Camera"))}));this.options.push(n),this.options.push(a),this.add.existing(n),this.add.existing(a);const o=new Re(this,new r(Ue,Ye+1*ti),si,Vt,this.configData,"skipLoopThreshold",new r(1,16),(t=>{t.label.setText("Skip Button After Loop: "+t.getStringValue()),this.configData[t.key]=t.getValue()})).setIsInteger(!0),h=new We(this,new r(Ue,Ye+1*ti+Mt.y),25,void 0,Xt,this.configData,"enableSkipButton",(t=>{this.configData[t.key]=t.isChecked,t.isChecked?o.draw():o.hide("Show Layer Skip Button")}));this.options.push(o),this.options.push(h),this.add.existing(o),this.add.existing(h);const l=new Re(this,new r(Ue,Ye+2*ti),si,Vt,this.configData,"autoSkipThreshold",new r(1,16),(t=>{t.label.setText("Skip Layers After Loop: "+t.getStringValue()),this.configData[t.key]=t.getValue()})).setIsInteger(!0),c=new We(this,new r(Ue,Ye+2*ti+Mt.y),25,void 0,Xt,this.configData,"enableAutoSkip",(t=>{this.configData[t.key]=t.isChecked,t.isChecked?l.draw():l.hide("Skip Layers Automatically")}));this.options.push(l),this.options.push(c),this.add.existing(l),this.add.existing(c);const d=new We(this,new r(Ue,ei+0*ii),25,new r(-Mt.x,0),"Disable Layer Progression",this.configData,"disableLayerProgression",(t=>{this.configData[t.key]=t.isChecked}));this.options.push(d),this.add.existing(d);const u=new We(this,new r(Ue,ei+1*ii),25,new r(-Mt.x,0),"Index Finger Pinches Only",this.configData,"indexFingerOnly",(t=>{this.configData[t.key]=t.isChecked}));this.options.push(u),this.add.existing(u);const g=new We(this,new r(Ue,ei+2*ii),25,new r(-Mt.x,0),"Disable Fancy Effects",this.configData,"fancyEffectsDisabled",(e=>{this.configData[e.key]=e.isChecked,e.isChecked?null!=this.rotateTween&&this.rotateTween.pause():e.isChecked||null!=this.rotateTween&&null!=t&&this.rotateTween.resume()}));this.options.push(g),this.add.existing(g);const p=new Re(this,new r(Xe,Ze+0*Qe),si,new r(0,Vt.y),this.configData,"onTimeDuration",new r(50,1e3),(t=>{t.label.setText("On Time Duration: "+t.getStringValue()+" ms"),this.configData[t.key]=t.getValue()})).setIsInteger(!0);this.options.push(p),this.add.existing(p);const v=new Re(this,new r(Xe,Ze+1*Qe),si,new r(0,Vt.y),this.configData,"lateTimeDuration",new r(50,1e3),(t=>{t.label.setText("Late Time Duration: "+t.getStringValue()+" ms"),this.configData[t.key]=t.getValue()})).setIsInteger(!0);this.options.push(v),this.add.existing(v);const m=new Re(this,new r(Xe,Ye+0*ti),si,new r(0,Vt.y),this.configData,"sonificationLevel",new r(0,1),(t=>{t.label.setText("Pinch Volume: "+t.getStringValue()),this.configData[t.key]=t.getValue()}));this.options.push(m),this.add.existing(m);const f=new Re(this,new r(Xe,Ye+1*ti),si,new r(0,Vt.y),this.configData,"backgroundMusicLevel",new r(0,1),(t=>{t.label.setText("Track Volume: "+t.getStringValue()),this.configData[t.key]=t.getValue()}));this.options.push(f),this.add.existing(f);const y=new We(this,new r(Xe,Ye+2*ti),25,new r(-Mt.x,0),"Require Single Pinches",this.configData,"singlePinchRequirement",(t=>{this.configData[t.key]=t.isChecked}));this.options.push(y),this.add.existing(y);const b=new We(this,new r(Xe,ei+0*ii),25,new r(-Mt.x,0),"Disable Visual Metronome",this.configData,"disableVisualMetronome",(t=>{this.configData[t.key]=t.isChecked}));this.options.push(b),this.add.existing(b);const w=new We(this,new r(Xe,ei+1*ii),25,new r(-Mt.x,0),"Disable Sonification",this.configData,"disableSonification",(t=>{this.configData[t.key]=t.isChecked}));this.options.push(w),this.add.existing(w),this.backToMenu.addPinchCallbacks({startPinch:()=>{this.saveAndExit()},startHover:()=>{this.backToMenu.setTintFill(at)},endHover:()=>{this.backToMenu.clearTint()}}),this.resetConfig.addPinchCallbacks({startPinch:()=>qe(this,void 0,void 0,(function*(){this.configData=structuredClone(this.defaultData);for(const t of this.options)t.reset(this.configData);this.setConfig()})),startHover:()=>{this.resetConfig.setTintFill(at)},endHover:()=>{this.resetConfig.clearTint()}})}update(t,e){super.update(t,e)}},class extends Se{constructor(){super(Rt),this.currentLevelIndex=0,this.difficultyButtons=[],this.levels=[],Yt(this.currentLevelIndex>=0,"Level select default level must be >= 0")}preload(){this.levels=this.scene.settings.data,Yt(this.currentLevelIndex<this.levels.length,"Cannot set defaut level select index above the number of levels"),this.load.image(I,ee("assets/ui/easy_button.png")),this.load.image(M,ee("assets/ui/medium_button.png")),this.load.image(V,ee("assets/ui/hard_button.png")),this.load.image(N,ee(X)),this.load.image(z,ee(Z)),this.load.image(A,ee(U)),this.load.image(_,ee("assets/ui/play_button.png")),this.load.image(R,ee("assets/ui/left_arrow.png")),this.load.image(W,ee("assets/ui/right_arrow.png")),this.load.image(G,ee("assets/ui/default_preview_background.png")),this.load.image(x,ee("assets/ui/video_background.png")),this.load.image(k,ee("assets/ui/song_name_background.png"))}create(){super.create();const t=window.innerWidth,e=window.innerHeight,i=.5*t;this.play=new Pe(this,new r(i,.9*e),_t,_,E,!0),this.previousLevel=new Pe(this,new r(i-.235*t,At*e),new r(.4,.4),R,E,!0),this.nextLevel=new Pe(this,new r(i+.235*t,At*e),new r(.4,.4),W,E,!0),this.backToMenu=new Pe(this,new r(i-.4*t,.9*e),_t,A,E,!0),this.muteButton=new Fe(this,new r(i+.45*t,.9*e),new r(1.5,1.5),N,z,E,!0,!0),this.input.keyboard.on(pt,(()=>{this.scene.start(zt),this.exit()})),this.add.sprite(.5*window.innerWidth,.5*window.innerHeight-window.innerHeight*Ot,x).setScale(Ht.x,Ht.y).setOrigin(.5,.5),this.backToMenu.addPinchCallbacks({startPinch:()=>{this.scene.start(zt),this.exit()},startHover:()=>{this.backToMenu.setTintFill(at)},endHover:()=>{this.backToMenu.clearTint()}}),this.play.addPinchCallbacks({startPinch:()=>{this.startLevel(this.getCurrentLevel())},startHover:()=>{this.play.setTintFill(at)},endHover:()=>{this.play.clearTint()}}),this.add.sprite(i,e*At,k).setTintFill(0).setScale(.4,.4).setOrigin(.5,.5),this.songName=this.add.text(i,e*At,Xt,{font:"50px Courier New"}).setColor("white").setOrigin(.5,.5),this.updateLevel(0),this.previousLevel.addPinchCallbacks({startPinch:()=>{this.updateLevel(-1)},startHover:()=>{this.previousLevel.setTintFill(at)},endHover:()=>{this.previousLevel.clearTint()}}),this.nextLevel.addPinchCallbacks({startPinch:()=>{this.updateLevel(1)},startHover:()=>{this.nextLevel.setTintFill(at)},endHover:()=>{this.nextLevel.clearTint()}}),this.muteButton.addToggleCallback((t=>{this.setBackgroundAudioMute(!t)})),this.muteButton.addPinchCallbacks({startPinch:()=>{this.muteButton.toggle()},startHover:()=>{this.muteButton.setTintFill(at)},endHover:()=>{this.muteButton.clearTint()}})}exit(){this.stopAudio()}startLevel(t){this.exit(),this.scene.start(jt,t)}createDifficultyButtons(t){const e=window.innerWidth,i=window.innerHeight,s=.5*e;for(const t of this.difficultyButtons)t.destroy();this.difficultyButtons=[];const n=t.track.data.bpm,a=[I,M,V],o=[new r(s-.2*e,Et*i),new r(s,Et*i),new r(s+.2*e,Et*i)];Yt(a.length>=n.length,"buttonKeys array length must at least match the number of track bpms"),Yt(o.length>=n.length,"positions array length must at least match the number of track bpms");for(let e=0;e<n.length;e++){const i=e,s=n[e],h=a[e],l=0==e,c=new je(this,o[e],new r(.4,.4),h,h,E,!0,i,s,l);c.addToggleCallback((e=>{c.updateTint(),e&&(t.setBPM(c.bpmIndex),this.startPreview(t))})),c.addPinchCallbacks({startPinch:()=>{for(const t of this.getDifficultyButtons())t!=c&&t.setToggleState(!1);c.setToggleState(!0)},startHover:()=>{c.setTintFill(at)},endHover:()=>{c.updateTint()}}),this.difficultyButtons.push(c)}}getDifficultyButtons(){return this.difficultyButtons}setBackgroundAudioMute(t){for(const e of this.levels)e.setBackgroundAudioMute(t)}startVideo(t){if(null!=this.videoPreview&&this.videoPreview.destroy(),t.hasPreviewVideo()){this.videoPreview=this.add.video(.5*window.innerWidth,.5*window.innerHeight-window.innerHeight*Ot,t.getPreviewVideoKey()).setScale(Ht.x,Ht.y).setOrigin(.5,.5);const e=t.track.data.bpm[t.bpmIndex]/t.track.data.bpm[0];this.videoPreview.video&&(this.videoPreview.video.playbackRate=e),this.videoPreview.play(!0)}else this.videoPreview=this.add.sprite(.5*window.innerWidth,.5*window.innerHeight-window.innerHeight*Ot,G).setScale(Ht.x,Ht.y).setOrigin(.5,.5)}startPreview(t){this.stopAudio(),t.addBackgroundAudio(this,{loop:!0,volume:.5*oe.backgroundMusicLevel}),t.playBackgroundAudio(),t.setBackgroundAudioMute(!this.muteButton.getToggleState());const e=1e3*t.getAudioLoopTime();this.videoRefreshEvent=this.time.addEvent({delay:e,callback:()=>{this.startVideo(t)},callbackScope:this,loop:!0,startAt:e})}stopAudio(){this.videoRefreshEvent&&this.videoRefreshEvent.destroy();for(const t of this.levels)t.removeBackgroundAudio(this)}updateLevel(t){this.cycleLevel(t);const e=this.getCurrentLevel();this.songName.setText(e.track.data.displayName),Yt(0<e.track.data.bpm.length,"Default difficulty button index must be in range of default track BPM"),e.setBPM(0),this.startPreview(e),this.createDifficultyButtons(e)}cycleLevel(t){const e=this.levels.length;this.currentLevelIndex=((this.currentLevelIndex+t)%e+e)%e}getCurrentLevel(){return Yt(this.currentLevelIndex<this.levels.length,"Current level index out of range of this.levels array"),this.levels[this.currentLevelIndex]}getCurrentLevelKey(){return"level"+(this.currentLevelIndex+1).toString()}update(t,e){super.update(t,e)}},class extends Se{constructor(){super(jt)}preload(){this.level=this.scene.settings.data,this.level.init(this),this.load.image($,ee("assets/ui/default_level_background.png"))}create(){super.create(),this.level.hasCustomBackground()?this.setBackgroundTexture(this.level.getBackgroundTextureKey()):this.setBackgroundTexture($),this.input.keyboard.on(pt,(()=>{this.level.abort()})),this.level.start((()=>{this.scene.start(Nt,this.level)}),(()=>{this.scene.start(zt)}))}update(t,e){super.update(t,e),this.level.update(t)}},class extends Se{constructor(){super(Nt)}exit(){this.level.removeBackgroundAudio(this),this.scene.start(zt)}preload(){this.load.audio(E,ee(w)),this.load.image(A,ee(U)),this.load.image(N,ee(X)),this.load.image(z,ee(Z)),this.load.image(q,ee("assets/ui/save_csv_button.png")),this.load.image(S,ee("assets/ui/layer_score_background.png")),this.load.image(P,ee("assets/ui/scoreboard_background.png")),this.level=this.scene.settings.data,this.levelStats=this.level.score.levelStats,oe.autoSaveCSV&&ce(this.level.score.levelStats)}create(){super.create();const t=window.innerWidth,e=window.innerHeight,i=.5*t,s=Math.min(t/1920,e/1080);this.backToMenu=new Pe(this,new r(i,.9*e),_t,A,E,!0),this.muteButton=new Fe(this,new r(i+.45*t,.9*e),It,N,z,E,!0,!0),this.level.addBackgroundAudio(this,{loop:!0,volume:.5*oe.backgroundMusicLevel}),this.level.playBackgroundAudio(),this.muteButton.addToggleCallback((t=>{this.level.setBackgroundAudioMute(!t)})),this.muteButton.addPinchCallbacks({startPinch:()=>{this.muteButton.toggle()},startHover:()=>{this.muteButton.setTintFill(at)},endHover:()=>{this.muteButton.clearTint()}}),this.input.keyboard.on(pt,(()=>{this.exit()})),oe.autoSaveCSV||(this.saveButton=new Pe(this,new r(i-.4*t,.9*e),new r(.6,.6),q,E,!0),this.saveButton.addPinchCallbacks({startPinch:()=>{!function(t){const e=new Blob([a(t)],{type:"text/plain;charset=utf-8"});ae().saveAs(e,t.id+".csv")}(this.levelStats)},startHover:()=>{this.saveButton.setTintFill(at)},endHover:()=>{this.saveButton.clearTint()}})),this.add.sprite(0,0,P).setOrigin(.5,.5).setScale(1.35*s,1.25*s).setAlpha(.6).setPosition(i,.25*e);const n=this.add.text(i,0,"Scoreboard",{color:"#01c303",font:96*s+"px Arial"});n.setStroke("#000",6*s),n.setPosition(i-n.width/2,.07*e);const o=this.levelStats.layersStats.reduce(((t,e)=>t+e.total),0),h=this.levelStats.layersStats.reduce(((t,e)=>t+e.correct),0),l=this.levelStats.layersStats.reduce(((t,e)=>t+e.miss),0),c=this.levelStats.layersStats.reduce(((t,e)=>t+e.early),0),d=this.levelStats.layersStats.reduce(((t,e)=>t+e.late),0),u=this.add.text(i,0,`Total Correct: ${h.toString()}/${o.toString()}\nLongest Streak: ${this.levelStats.maxStreak}\nMissed: ${l}\nEarly: ${c}\nLate: ${d}`,{color:"#ffffff",align:"center",font:48*s+"px Arial"});u.setPosition(i-u.width/2,.19*e);const g=[.25,.5,.75],p=g;this.level.track.forEachLayer(void 0,((i,n)=>{this.add.sprite(0,0,S).setOrigin(.5,.5).setScale(1.35*s,1.15*s).setAlpha(.6).setPosition(t*g[n],.63*e);const a=this.add.text(0,0,`${o=i.id,o&&o[0].toUpperCase()+o.slice(1)||""}`,{color:"#01c303",align:"center",font:72*s+"px Arial",fontStyle:"bold"});var o;a.setStroke("#000",4*s),a.setPosition(t*p[n]-a.width/2,.53*e);const r=this.levelStats.layersStats[n];let h=0,l=0,c=0;null!=r&&(h=r.correct,l=r.total,c=r.loop);const d=this.add.text(0,0,`\nCorrect: ${h.toString()}/${l.toString()}\nLoops: ${c.toString()}`,{color:"#ffffff",align:"center",font:48*s+"px Arial"});d.setPosition(t*p[n]-d.width/2,.575*e+.01)})),this.backToMenu.addPinchCallbacks({startPinch:()=>{this.exit()},startHover:()=>{this.backToMenu.setTintFill(at)},endHover:()=>{this.backToMenu.clearTint()}})}update(t,e){super.update(t,e)}},class extends Se{constructor(){super(Wt)}exit(){this.scene.start(zt)}preload(){this.load.image(A,ee(U)),this.load.audio(E,ee(w)),this.load.image(K,ee("assets/ui/calibration_background.png"))}create(){super.create(!0,.8);const t=window.innerWidth,e=window.innerHeight,i=.5*t;this.backToMenu=new Pe(this,new r(i,.9*e),_t,A,E,!0),this.setBackgroundTexture(K),this.input.keyboard.on(pt,(()=>{this.exit()})),this.distanceText=this.add.text(i,.1*e,Xt,{color:"white",font:"60px Arial"}).setShadow(5,5,"rgba(0,0,0,0.5)",15).setOrigin(.5,.5),this.backToMenu.addPinchCallbacks({startPinch:()=>{this.exit()},startHover:()=>{this.backToMenu.setTintFill(at)},endHover:()=>{this.backToMenu.clearTint()}})}update(t,e){super.update(t,e);const i=this.hand.calculateHandDistance();let s="Hand Not Recognized";if(i>0){let t=65280;i>40?(s="Too Far - Estimated Distance: ",t=16711680):i<20?(s="Too Close - Estimated Distance: ",t=255):s="Just Right - Estimated Distance: ",this.setBackgroundTint(t),s+=i.toFixed(0)+" cm"}else this.clearBackgroundTint();null!=this.distanceText&&this.distanceText.active&&this.distanceText.setText(s)}}]};function ci(){new(n().Game)(li)}const di=(0,ni.Wp)({apiKey:"AIzaSyAHkhSVhXo1qrE3lYqXEh2ozwOgZJhk960",authDomain:"pizzicato-1f765.firebaseapp.com",projectId:"pizzicato-1f765",storageBucket:"pizzicato-1f765.firebasestorage.app",messagingSenderId:"196367706867",appId:"1:196367706867:web:bb5cac34655842ac462586",databaseURL:"https://pizzicato-1f765-default-rtdb.europe-west1.firebasedatabase.app/"}),ui=((0,ai.xI)(di),(0,oi.C3)(di)),gi="@pizzicato.com";function pi(){return hi?hi.email.replace(gi,""):"guest"}function vi(t,e){return ri(this,void 0,void 0,(function*(){return new Promise(((i,s)=>{const n=(0,oi.KR)(ui,`users/${hi.uid}/data/${t}`);(0,oi.hZ)(n,e).then((()=>{i('Data written successfully for user "'+pi()+'"')})).catch((t=>{s('Data not found for user "'+pi()+'":'+t)}))}))}))}function mi(){return ri(this,void 0,void 0,(function*(){return new Promise(((t,e)=>{const i=(0,oi.KR)(ui);(0,oi.Jt)((0,oi.jf)(i,`users/${hi.uid}`)).then((i=>{if(i.exists()){const s=i.val();(function(t){return ri(this,void 0,void 0,(function*(){return new Promise(((e,i)=>{if(t){const s=(0,oi.KR)(ui);(0,oi.Jt)((0,oi.jf)(s,`configs/${t}`)).then((t=>{t.exists()?e(t.val()):i("Config name snapshot does not exist: resorting to default config")})).catch((t=>{i("Firebase get configs failed: "+t)}))}else i("Undefined config name: resorting to default config")}))}))})(s.config).then((i=>{s.config?t([i,s.config]):e("Undefined config name")})).catch((t=>{e("Failed to retrieve config: "+t)}))}else e("User id snapshot does not exist: resorting to default config")})).catch((t=>{e("Firebase get users failed: "+t)}))}))}))}document.body.innerHTML+='<div id="background_image"></div>',ci()}},i={};function s(t){var n=i[t];if(void 0!==n)return n.exports;var a=i[t]={exports:{}};return e[t].call(a.exports,a,a.exports,s),a.exports}s.m=e,t=[],s.O=(e,i,n,a)=>{if(!i){var o=1/0;for(c=0;c<t.length;c++){for(var[i,n,a]=t[c],r=!0,h=0;h<i.length;h++)(!1&a||o>=a)&&Object.keys(s.O).every((t=>s.O[t](i[h])))?i.splice(h--,1):(r=!1,a<o&&(o=a));if(r){t.splice(c--,1);var l=n();void 0!==l&&(e=l)}}return e}a=a||0;for(var c=t.length;c>0&&t[c-1][2]>a;c--)t[c]=t[c-1];t[c]=[i,n,a]},s.n=t=>{var e=t&&t.__esModule?()=>t.default:()=>t;return s.d(e,{a:e}),e},s.d=(t,e)=>{for(var i in e)s.o(e,i)&&!s.o(t,i)&&Object.defineProperty(t,i,{enumerable:!0,get:e[i]})},s.g=function(){if("object"==typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(t){if("object"==typeof window)return window}}(),s.o=(t,e)=>Object.prototype.hasOwnProperty.call(t,e),(()=>{var t={792:0};s.O.j=e=>0===t[e];var e=(e,i)=>{var n,a,[o,r,h]=i,l=0;if(o.some((e=>0!==t[e]))){for(n in r)s.o(r,n)&&(s.m[n]=r[n]);if(h)var c=h(s)}for(e&&e(i);l<o.length;l++)a=o[l],s.o(t,a)&&t[a]&&t[a][0](),t[a]=0;return s.O(c)},i=self.webpackChunkPizzicato=self.webpackChunkPizzicato||[];i.forEach(e.bind(null,0)),i.push=e.bind(null,i.push.bind(i))})();var n=s.O(void 0,[96],(()=>s(852)));n=s.O(n)})();