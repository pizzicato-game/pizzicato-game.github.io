(()=>{"use strict";var t,e={852:(t,e,i)=>{i.d(e,{Ny:()=>Xt,lW:()=>se,ID:()=>ee,vh:()=>ie});var s=i(440),n=i.n(s);const o=Phaser.Math.Vector2,a=Phaser.GameObjects.Group,h=Phaser.GameObjects.Graphics,r=Phaser.Time.TimerEvent,l=Phaser.GameObjects.GameObject,d=Phaser.Geom.Rectangle,c=(Phaser.Geom.Circle,Phaser.Input.Pointer,Phaser.GameObjects.Text),u=(Phaser.GameObjects.Sprite,Phaser.GameObjects.Video,Phaser.GameObjects.RenderTexture,Phaser.Events.EventEmitter,Phaser.GameObjects.Image,Phaser.Scene),g=(Phaser.Tilemaps.Tile,Phaser.Tweens.Tween,Phaser.GameObjects.Particles.ParticleEmitter,Phaser.Physics.Matter.Sprite),p=(Phaser.Physics.Arcade.Sprite,!0),m="levels/",y=m+"list.json",v=".mp3",f={thumb:16777215,index:14948892,middle:38655,ring:16771584,pinky:14315734},w={lineWidth:5,color:11393254,alpha:.5},b={lineWidth:5,color:11393254,alpha:1,radius:.1},x="thumb",T="index",k="middle",P="ring",S="pinky",C={align:"center",font:"50px Courier New",color:"#01C303"},L=T,B=16777215,O=B,I=14948892,D=I,E=16777215,V="linear",A={scale:1.03,color:16777215,ease:"linear"},N={scale:.78,color:5091146,ease:"linear"},F={scale:.3,color:16744192,ease:"linear"},M={scale:0,color:8421504,ease:"cubic.in"},z="keydown-ESC",_={color:"white",scale:1,font:"30px Courier New",depth:40,strokeThickness:0,shadowOffset:new o(2,2),shadowColor:"black",shadowBlurRadius:2},H={color:[16436258,16291840,16266752,10421252],colorEase:"quad.out",lifespan:500,scale:{start:.7,end:0,ease:"sine.out"},speed:200,advance:500,frequency:50,blendMode:"ADD",duration:0},K={requiredTint:524543,completedRequiredTint:2840741,completedTint:N.color,extraTint:N.color,tintByNode:!1},j="Easy",R="Medium",$="Hard",G=new o(-32,-32),q=new o(32,-32),W="mainMenu",U={visible:!1,flip:!0,opacity:0,objectFit:"fill"},X={video:{width:{ideal:640},height:{ideal:360}},audio:!1},Y={baseOptions:{delegate:"GPU"},runningMode:"VIDEO",numHands:1,minHandDetectionConfidence:.5,minHandPresenceConfidence:.5,minTrackingConfidence:.5},J="UNDEFINED";function Q(t,e="no error message provided"){if(p&&!t)throw new Error("Assertion failed: "+e)}function Z(t,e=""){const i="".replace(/\\/g,"/")+e;return t=t.replace(/\\/g,"/"),"/"==Array.from(t)[0]?i+t:i+"/"+t}function tt(t){return Z(t,"")}var et=function(t,e,i,s){return new(i||(i=Promise))((function(n,o){function a(t){try{r(s.next(t))}catch(t){o(t)}}function h(t){try{r(s.throw(t))}catch(t){o(t)}}function r(t){var e;t.done?n(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(a,h)}r((s=s.apply(t,e||[])).next())}))};const it=new class{init(t,e,i,s){return et(this,void 0,void 0,(function*(){return new Promise(((n,o)=>et(this,void 0,void 0,(function*(){s("LOADING WEBCAM..."),this.setupVideoElement(t,e,i),yield navigator.mediaDevices.getUserMedia(X).then((t=>{"srcObject"in this.video?(this.video.srcObject=t,this.video.addEventListener("loadeddata",(()=>{n(!0)}))):o("srcObject does not exist on older browsers")})).catch((t=>{o(t)}))}))))}))}found(){return null!=this.video.srcObject}setVisibility(t){this.video.style.visibility="",this.video.style.visibility=t?"shown":"hidden"}setupVideoElement(t,e,i){this.video=document.body.appendChild(document.createElement("video")),this.video.autoplay=!0,this.video.muted=!0,this.video.playsInline=!0,this.video.width=e,this.video.height=i,t.flip&&(this.video.style.cssText+="-moz-transform: translate(-50%, -50%) scale(-1, 1);          -webkit-transform: translate(-50%, -50%) scale(-1, 1); -o-transform: translate(-50%, -50%) scale(-1, 1);          transform: translate(-50%, -50%) scale(-1, 1); filter: FlipH;"),this.setVisibility(!1)}get video(){return Q(null!=this.video_),this.video_}set video(t){this.video_=t}};var st=i(260),nt=function(t,e,i,s){return new(i||(i=Promise))((function(n,o){function a(t){try{r(s.next(t))}catch(t){o(t)}}function h(t){try{r(s.throw(t))}catch(t){o(t)}}function r(t){var e;t.done?n(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(a,h)}r((s=s.apply(t,e||[])).next())}))};const ot=new class{constructor(){this.lastVideoTime=-1}init(t){return nt(this,void 0,void 0,(function*(){return new Promise(((e,i)=>nt(this,void 0,void 0,(function*(){let s;yield st.Ps.forVisionTasks(Z("models/wasm")).then((t=>s=t)).catch((t=>{i(t)})),t("LOADING HAND TRACKER..."),Y.baseOptions.modelAssetPath=tt("models/hand_landmarker.task"),yield st.Vb.createFromOptions(s,Y).then((t=>this.handLandmarker=t)).catch((t=>{t instanceof Event&&"error"==t.type&&i("Failed to fetch vision_wasm_internal.js in specified wasm directory"),t instanceof TypeError&&i("Failed to fetch hand_landmark.task file"),i(t)})),e(!0)}))))}))}precache(t){t("PRE-CACHING LANDMARKS..."),this.update()}found(){return null!=this.handLandmarker}update(){this.lastVideoTime!=it.video.currentTime&&(this.lastVideoTime=it.video.currentTime,this.results=this.handLandmarker.detectForVideo(it.video,performance.now()))}landmarksFound(t=0){return null!=this.results&&t<this.results.landmarks.length}landmarkFound(t,e=0){if(!this.landmarksFound(e))return!1;const i=this.results.landmarks[e][t];return i.x>=0&&i.x<=1&&i.y>=0&&i.y<=1}getNormalizedLandmarkPosition(t,e=0){if(!this.landmarksFound(e))return;const i=this.results.landmarks[e][t];return new o(1-i.x,i.y)}forEachNormalizedLandmarkPosition(t,e=0){for(let i=0;i<21;++i){const s=this.getNormalizedLandmarkPosition(i,e);null!=s&&t(s)}}};function at(t){let e="layerID,noteID,pinchType,loopNumber,playerTime,correctTime,classification,normalizedTargetRadius,normalizedTargetPositionX,normalizedTargetPositionY,normalizedFingerRadius,normalizedPinkyFingerPositionX,normalizedPinkyFingerPositionY,normalizedRingFingerPositionX,normalizedRingFingerPositionY,normalizedMiddleFingerPositionX,normalizedMiddleFingerPositionY,normalizedIndexFingerPositionX,normalizedIndexFingerPositionY,normalizedThumbFingerPositionX,normalizedThumbFingerPositionY\n";for(const i of t.layersStats){const s=t.layersStats.indexOf(i);for(const t of i.hits){const i=t.normalizedFingerRadius?t.normalizedFingerRadius:null,[n,o]=t.normalizedTargetPosition,[a,h]=t.normalizedPinkyFingerPosition?t.normalizedPinkyFingerPosition:[null,null],[r,l]=t.normalizedRingFingerPosition?t.normalizedRingFingerPosition:[null,null],[d,c]=t.normalizedMiddleFingerPosition?t.normalizedMiddleFingerPosition:[null,null],[u,g]=t.normalizedIndexFingerPosition?t.normalizedIndexFingerPosition:[null,null],[p,m]=t.normalizedThumbFingerPosition?t.normalizedThumbFingerPosition:[null,null];e+=`${s},${t.noteID},${t.pinchType},${t.loopNumber},${ht(t.playerTime)},${ht(t.correctTime)},${t.classification},${t.normalizedTargetRadius},${n},${o},${i},${a},${h},${r},${l},${d},${c},${u},${g},${p},${m}\n`}}return e}function ht(t,e=3){return parseFloat((t/1e3).toFixed(e))}var rt=i(213),lt=i.n(rt);let dt,ct;function ut(t,e=!0){ct=structuredClone(t),e&&(console.info("INFO: Config set to:"),console.info(ct))}function gt(t,e){ct[t]=e}function pt(t){if(Xt){const e=JSON.parse(JSON.stringify(t));ie(t.id,e).then((t=>{console.info("INFO: "+t)})).catch((t=>{console.info("INFO: "+t)}))}}class mt{constructor(t,e){this.trackKey=J,this.bpm=0,this.beatLength_=1,this.scene=t,this.trackKey=e,this.trackDir=m+this.trackKey+"/",this.scene.load.json(this.trackKey,tt(this.trackDir+"info.json"))}get beatLength(){return this.beatLength_}setBPM(t){Q(null!=this.data,"preload JSON before setting BPM"),Q(t<this.data.bpm.length,"BPM index out of range"),this.bpm=this.data.bpm[t];const e=16/this.data.timeSignatureDenominator;this.beatLength_=this.songTimePositionToTime({bar:1,step:1+e,tick:0})}getBPM(){return Q(null!=this.data,"preload JSON before retrieving BPM"),Q(0!=this.bpm,"Track BPM has not been set"),this.bpm}preloadNotes(){Q(null!=this.trackDir,"Preload track before preloading notes"),this.forEachLayer(void 0,(t=>{t.nodes.forEach(((e,i)=>{const s=this.getSoundKey(t,e.soundKey),n=this.trackDir+t.id+"/"+e.soundKey+v;this.scene.cache.audio.exists(s)||""===e.soundKey||this.scene.load.audio(s,tt(n))}))}))}unloadNotes(){this.forEachLayer(void 0,(t=>{t.nodes.forEach(((e,i)=>{this.scene.cache.audio.remove(this.getSoundKey(t,e.soundKey))}))}))}preloadLoops(){this.forEachLayer((t=>{Q(null!=t.soundLoopKeys),Q(t.soundLoopKeys.length>0),t.soundLoopKeys.forEach((e=>{const i=this.getSoundKey(t,e),s=this.trackDir+t.id+"/"+e+v;this.scene.cache.audio.exists(i)||""===e||this.scene.load.audio(i,tt(s))}))}))}unloadLoops(){this.forEachLayer((t=>{t.soundLoopKeys.forEach((e=>{this.scene.cache.audio.remove(this.getSoundKey(t,e))}))}))}getSoundKey(t,e){return Q(null!=e),this.trackKey+"/"+t.id+"/"+e}forEachLayer(t,e){Q(null!=this.data,"JSON has not finished preloading");let i=0;this.data.layers.forEach(((s,n)=>{s.playable||i++,null==t||t(s,n),s.playable&&(null==e||e(s,n-i))}))}addBackgroundAudioTracks(t,e,i,s){const n=[];return this.forEachLayer(((o,a)=>{(null==s||s(o,a))&&(o.playable&&ct.playableBackingTracksEnabled||!o.playable&&ct.unplayableBackingTracksEnabled)&&(Q(null!=o.soundLoopKeys),Q(i<o.soundLoopKeys.length,"BPM index out of range of layer sound loop keys"),n.push(t.sound.add(this.getSoundKey(o,o.soundLoopKeys[i]),e)))})),n}timeToSongTimePosition(t){Q(0!=this.bpm,"set BPM before retrieving song times");const e=t/(6e4/this.bpm),i=Math.floor(e/this.data.timeSignatureNumerator)+1,s=e%this.data.timeSignatureNumerator,n=4*s%1;return{bar:i,step:Math.floor(s*(4/this.data.timeSignatureDenominator)*4)+1,tick:Math.floor(n*(this.data.timeBasePPQ/4))}}songTimePositionToTime(t){return Q(0!=this.bpm,"set BPM before retrieving song times"),((t.bar-1)*this.data.timeSignatureNumerator+(t.step-1)/(4/this.data.timeSignatureDenominator*4)+t.tick/this.data.timeBasePPQ)*(6e4/this.bpm)}preload(t){this.scene=t,this.data=this.scene.cache.json.get(this.trackKey),Q(null!=this.data,"Failed to retrieve JSON for track"),this.parseJson(),this.preloadLoops(),this.preloadNotes()}unload(){this.unloadLoops(),this.unloadNotes()}parseJson(){this.setTimePositionDefaults(),this.sortNodes()}setTimePositionDefaults(){this.forEachLayer(void 0,(t=>{const e=(t,e,i,s)=>{t.bar||(t.bar=e),t.step||(t.step=i),t.tick||(t.tick=s)};Q(t.progressCount<=t.nodes.length,"Progress count threshold for layer '"+t.id+"' of track '"+this.trackKey+"' cannot be higher than the node count."),e(t.previewTime,0,0,0),t.nodes.forEach((t=>{e(t.timePosition,1,1,0)}))}))}sortNodes(){this.forEachLayer(void 0,(t=>{t.nodes.sort(((t,e)=>t.timePosition.bar!==e.timePosition.bar?t.timePosition.bar-e.timePosition.bar:t.timePosition.step!==e.timePosition.step?t.timePosition.step-e.timePosition.step:t.timePosition.tick-e.timePosition.tick))}))}}class yt extends l{constructor(t){super(t,"metronome"),this.beat=0,this.timer=new r({}),this.countdownText=this.scene.add.text(t.center.x,t.center.y,J,{font:"240px Courier New",color:"white"}).setOrigin(.5,.5).setDepth(30),this.setVisible(!1),this.on("destroy",(()=>{this.shrinkTween&&this.shrinkTween.destroy(),this.countdownTexture&&this.countdownTexture.destroy(),this.countdownText&&this.countdownText.destroy(),this.timer&&this.timer.destroy()}))}setup(){this.countdownTexture=this.scene.add.sprite(this.countdownText.getCenter().x,this.countdownText.getCenter().y,"countdown").setScale(1).setVisible(!1).setAlpha(.3).setDepth(30)}setVisible(t){this.countdownText&&this.countdownText.setVisible(t),this.countdownTexture&&this.countdownTexture.setVisible(t)}stop(){this.setVisible(!1),this.scene&&(this.scene.time.removeEvent(this.timer),this.scene.sound.stopByKey("metronomeHigh"),this.scene.sound.stopByKey("metronomeLow"),this.shrinkTween&&this.scene.tweens.remove(this.shrinkTween))}play(t,e,i){this.beat=0,this.stop(),this.timer=this.scene.time.addEvent({callback:this.tick.bind(this,t,e,i),delay:e,loop:!0,startAt:e})}tick(t,e,i){Q(i>=1,"Cannot display metronome for less than minimum bar count");const s=t*i,n=this.beat%t,o=0==n?"metronomeHigh":"metronomeLow";this.beat>=s?this.setVisible(!1):(this.countdownText.active&&this.scene.sound.play(o,{volume:ct.backgroundMusicVolume}),Q(s-t>=0),this.beat>=s-t&&this.countdownText.active&&ct.displayVisualMetronome&&this.display(n+1,e),this.beat++)}display(t,e){this.countdownText.setText(t.toString()),this.countdownText.setScale(1),this.countdownTexture.setScale(1),this.setVisible(!0),this.shrinkTween=this.scene.tweens.add({targets:[this.countdownText,this.countdownTexture],ease:"Power0",duration:.9*e,scale:0,repeat:0})}}class vt extends a{constructor(t){super(t),this.current_=0,this.requiredProgress=-1,this.nodeCount=1,this.tints=[],Q(this.current_>=0),this.tints=[],this.scene.add.existing(this),this.setVisible(!1)}setup(t,e,i,s){Q(i<=e),Q(s.length===e,"Must pass tints equal in number to nodes"),Q(e>0),Q(i>0),Q(t>=0),this.current_=t,this.nodeCount=e,this.tints=s,this.requiredProgress=i;const n=768/this.nodeCount;this.clear(),this.createMultiple({quantity:this.nodeCount,key:"progressSegment",visible:!0,setXY:{x:this.scene.scale.width/2-384+n/2,y:0,stepX:n},setOrigin:{x:.5,y:0}}),this.propertyValueSet("displayWidth",n),this.propertyValueSet("displayHeight",43),this.setDepth(61),this.redraw()}setToStarting(){this.current_=0,Q(this.current_>=0),this.redraw()}redraw(){if(this.current<=this.nodeCount){this.getChildren().forEach(((t,e)=>{t.clearTint()}));const t=-1===this.requiredProgress?this.nodeCount:this.requiredProgress-1,e=this.current;this.getChildren().forEach(((i,s)=>{const n=i;K.tintByNode&&n.setTint(this.tints[s]),s<e&&(s<=t?n.setTint(K.completedTint):n.setTint(K.extraTint)),s===t&&(e>t?n.setTint(K.completedRequiredTint):n.setTint(K.requiredTint))}),this)}}canProgress(){const t=-1===this.requiredProgress;return t&&this.current>=this.nodeCount||!t&&this.current>=this.requiredProgress}changeBy(t){this.current_=Math.max(0,Math.min(this.current+t,this.nodeCount))}get current(){return this.current_}}function ft(t,e,i){null!=t&&(t.setVisible(e),Object.hasOwn(t,"text")&&null!=t.text&&t.text.setVisible(e),e?t.setInteractive(i):t.disableInteractive())}class wt extends g{constructor(t,e,i,s,n=(()=>{}),o="button",a="pinch",h=.5,r=.5){if(super(t.matter.world,i,s,o,void 0,{render:{visible:!0},label:"button-"+o}),this.resetTint=!0,this.scene=t,this.scene.add.existing(this),this.setOrigin(h,r),this.sound=this.scene.sound.add(a,{volume:ct.pinchVolume}),""!==e){const t=this.getCenter();this.text=this.scene.add.text(t.x,t.y,e,C).setOrigin(.5,.5)}ft(this,!0),this.setSensor(!0),this.setDepth(93),this.setOnPinch(n),this.on("destroy",(()=>{this.scene.hand.removePinchCheck(L,this),this.sound&&(this.sound.isPlaying?this.sound.on("complete",(()=>{this.sound.destroy()})):this.sound.destroy()),this.text&&this.text.destroy()}))}removePinchCallbacks(){this.scene.hand.removePinchCheck(L,this)}setOnPinch(t){this.setPinchCallbacks({startPinch:t,startHover:()=>{(this.resetTint||16777215==this.tint)&&(this.text&&this.text.visible&&this.text.setTintFill(O),this.setTintFill(B))},endHover:()=>{(this.resetTint||this.tint==O)&&(this.text&&this.text.visible&&this.text.clearTint(),this.clearTint())}})}setPinchCallbacks(t){const e=()=>{var e;null===(e=t.startPinch)||void 0===e||e.call(t),this.sound.play({volume:ct.pinchVolume})},i={startPinch:()=>{ct.uiPinchesEnabled&&e()},pinched:()=>{var e;ct.uiPinchesEnabled&&(null===(e=t.pinched)||void 0===e||e.call(t))},endPinch:()=>{var e;ct.uiPinchesEnabled&&(null===(e=t.endPinch)||void 0===e||e.call(t))},startHover:()=>{var e;ct.uiPinchesEnabled&&(null===(e=t.startHover)||void 0===e||e.call(t))},endHover:()=>{var e;ct.uiPinchesEnabled&&(null===(e=t.endHover)||void 0===e||e.call(t))}};this.scene.hand.addPinchCheck(L,this,i),this.on("pointerdown",e),t.startHover&&this.on("pointermove",t.startHover),t.endHover&&this.on("pointerout",t.endHover)}}class bt extends l{constructor(t,e){super(t,"infoHUD"),this.scene=t,this.level=e,this.on("destroy",(()=>{this.trackText&&this.trackText.destroy(),this.difficultyText&&this.difficultyText.destroy(),this.bpmText&&this.bpmText.destroy(),this.layerText&&this.layerText.destroy(),this.loopText&&this.loopText.destroy(),this.infoBackground&&this.infoBackground.destroy(),this.skipButton&&this.skipButton.destroy()}))}setup(){this.addTexts(),this.addSkipButton(),this.setVisible(!1)}addSkipButton(){this.skipButton=new wt(this.scene,"SKIP LAYER",this.scene.width-200,this.scene.height-100,(()=>{ft(this.skipButton,!1),this.level.transitionLayers()})),this.skipButton.setScale(.8),this.skipButton.text.setScale(.8),this.skipButton.setPosition(this.scene.width-this.skipButton.displayWidth/2,this.scene.height-this.skipButton.displayHeight/2);const t=this.skipButton.getCenter();this.skipButton.text.setPosition(t.x,t.y),this.updateSkipButtonAvailability(!1)}setVisible(t){this.trackText&&this.trackText.setVisible(t),this.difficultyText&&this.difficultyText.setVisible(t),this.bpmText&&this.bpmText.setVisible(t),this.layerText&&this.layerText.setVisible(t),this.loopText&&this.loopText.setVisible(t),this.infoBackground&&this.infoBackground.setVisible(t),this.skipButton&&(this.skipButton.setVisible(t),this.skipButton.text&&this.skipButton.text.setVisible(t)),this.updateSkipButtonAvailability(t)}addText(t,e){return this.scene.add.text(t.position.x,t.position.y,e,{font:t.font,color:t.color}).setScale(t.scale).setDepth(t.depth)}getLoopText(){let t="Loop: "+this.level.score.getLoopCount().toString();return ct.skipLayersAutomatically&&(t+="/"+ct.skipLayersAutomaticallyAfterLoop.toString()),t}addTexts(){this.loopText=this.addText({position:new o(.85*this.scene.width,.22*this.scene.height),color:"white",font:"20px Courier New",scale:1,depth:40},this.getLoopText());const t="Track: "+this.level.track.data.displayName;this.trackText=this.addText({position:new o(.85*this.scene.width,.02*this.scene.height),color:"white",font:"20px Courier New",scale:1,depth:40},t);const e="Layer: "+(this.level.activeLayerIndex+1).toString()+"/"+this.level.playableLayers.length.toString();let i=J;switch(this.level.bpmIndex){case 0:i=j;break;case 1:i=R;break;case 2:i=$}Q(i!=J,"Extend the switch statement to have a difficulty text for the given track bpmIndex"),this.difficultyText=this.addText({position:new o(.85*this.scene.width,.07*this.scene.height),color:"white",font:"20px Courier New",scale:1,depth:40},"Difficulty: "+i),this.bpmText=this.addText({position:new o(.85*this.scene.width,.12*this.scene.height),color:"white",font:"20px Courier New",scale:1,depth:40},"BPM: "+this.level.track.getBPM()),this.layerText=this.addText({position:new o(.85*this.scene.width,.17*this.scene.height),color:"white",font:"20px Courier New",scale:1,depth:40},e),this.infoBackground=this.scene.add.sprite(this.scene.width,0,"trackInfoBackground").setAlpha(.3).setOrigin(1,0)}updateLoopText(){this.loopText.setText(this.getLoopText()),this.updateSkipButtonAvailability(!0)}updateSkipButtonAvailability(t){const e=ct.showSkipButton&&this.level.score.getLoopCount()>=ct.skipButtonAppearsAfterLoop&&t;this.skipButton&&ft(this.skipButton,e)}}class xt{constructor(){this.targets=[]}start(){this.destroyTargets()}destroyTarget(t){t.destroy();const e=this.targets.indexOf(t,0);e>-1&&this.targets.splice(e,1)}destroyTargets(){const t=[...this.targets];for(const e of t)this.destroyTarget(e)}addTarget(t){this.targets.push(t)}getPreviousTargets(t){return this.targets.filter((e=>e.songTime<t.songTime))}}class Tt extends g{constructor(t,e,i,s,n,a,h,r){const l=new o(i.x*t.width,i.y*t.height);super(t.matter.world,l.x,l.y,a.data.spriteKeyInner,void 0,{render:{visible:!0}}),this.scene=t,this.normalizedPosition=[i.x,i.y],this.lifetime=s,this.fingerId=h,this.nodeIndex=r,this.spriteScale=ct.targetSize,this.scene.add.existing(this),this.songTime=this.lifetime+e,this.lateDuration=ct.lateTimeDuration,this.onTimeDuration=ct.onTimeDuration,this.earlyDuration=this.lifetime-this.onTimeDuration/2,this.sound=this.scene.sound.add(n,{volume:ct.pinchVolume}),this.setScale(this.spriteScale),this.setTint(f[this.fingerId]),this.setDepth(95),ft(this,!0);const d=this.displayWidth/2;this.normalizedRadius=d/t.width,this.setCircle(d,{label:a.level.trackKey+"-"+a.data.id+"-node-"+r.toString()}),this.setSensor(!0),ct.postProcessingDisabled||(this.glow=this.postFX.addGlow(E,0,0,!1,.05,24)),this.outerRing=this.scene.add.sprite(l.x,l.y,a.data.spriteKeyOuter),this.outerRing.setScale(.5*this.spriteScale),this.outerRing.setDepth(96),this.targetText=new c(this.scene,0,0,J,{}).setOrigin(.5,.5),this.addTargetText(),this.setupTweens(),this.on("destroy",(()=>{this.scene&&this.scene.hand&&this.scene.hand.removePinchCheck(this.fingerId,this),this.off("pointerdown"),this.rotateTween&&this.scene.tweens.remove(this.rotateTween),this.earlyTween&&this.scene.tweens.remove(this.earlyTween),this.onTimeTween&&this.scene.tweens.remove(this.onTimeTween),this.lateTween&&this.scene.tweens.remove(this.lateTween),this.deathTween&&this.scene.tweens.remove(this.deathTween),this.glowTween&&this.scene.tweens.remove(this.glowTween),this.glow&&this.glow.destroy(),this.targetText&&this.targetText.destroy(),this.outerRing&&this.outerRing.destroy(),this.sound&&(this.sound.isPlaying?this.sound.on("complete",(()=>{this.sound.destroy()})):this.sound.destroy())}))}setOnTargetMiss(t){this.onTargetMiss=t}setOnTargetHit(t){this.scene.hand.addPinchCheck(this.fingerId,this,{startPinch:t}),ct.mousePinchesEnabled&&this.once("pointerdown",t)}addTargetText(){this.targetText=this.scene.add.text(this.x,this.y,(this.nodeIndex+1).toString(),{font:"30px Courier New",color:"white"}).setOrigin(.5,.5),this.targetText.setDepth(97)}createTween(t,e,i){for(const i of t)i.tint=e.color;return this.scene.tweens.add({targets:t,displayWidth:this.displayWidth*e.scale,displayHeight:this.displayHeight*e.scale,ease:e.ease,duration:i,repeat:0})}setupTweens(){this.rotateTween=this.scene.tweens.add({targets:[this],rotation:2*Math.PI,ease:"linear",duration:1e3,repeat:-1}),this.earlyTween=this.createTween([this.outerRing],A,this.earlyDuration),this.earlyTween.on("complete",(()=>{this.onTimeTween=this.createTween([this],Object.assign(Object.assign({},N),{scale:1}),this.onTimeDuration),!ct.postProcessingDisabled&&this.glow&&(this.glowTween=this.scene.tweens.add({targets:this.glow,outerStrength:4,yoyo:!0,duration:this.onTimeDuration/2,ease:V})),this.onTimeTween.on("complete",(()=>{this.glow&&this.glow.destroy(),this.lateTween=this.createTween([this,this.outerRing],Object.assign(Object.assign({},F),{scale:1}),this.lateDuration),this.lateTween.on("complete",(()=>{ft(this,!1),this.deathTween=this.createTween([this,this.outerRing,this.targetText],M,400),this.onTargetMiss&&this.deathTween.on("complete",this.onTargetMiss)}))}))}))}}class kt{constructor(t,e){this.level=t,this.data=e}getDuration(){return this.level.track.songTimePositionToTime({bar:this.data.lengthInBars+1,step:1,tick:0})}}class Pt extends kt{constructor(t,e,i){super(e,i),this.nextNodeIndex=0,this.songTime_=0,this.oldTimePosition=0,this.startTime=0,this.time=0,this.ready=!1,this.scene=t,this.data=i,this.targetManager=new xt}init(t){this.scene=t,this.metronome=new yt(this.scene),this.progress=new vt(this.scene),this.infoHud=new bt(this.scene,this.level)}get songTime(){return this.songTime_}unload(){this.infoHud.destroy()}start(t){this.targetManager.start(),this.level.score.delay=t,this.ready=!0,this.startTime=this.time+t,this.nextNodeIndex=0,this.oldTimePosition=0;const e=Math.max(this.data.previewTime.bar,1),i=[];this.data.nodes.forEach(((t,e)=>{const s=ct.indexFingerOnly?T:t.finger;i.push(f[s])})),this.progress.setup(0,this.data.nodes.length,this.data.progressCount,i),this.metronome.setup(),this.infoHud.setup(),this.progress.setVisible(!0),this.infoHud.setVisible(!0),this.metronome.play(this.level.track.data.timeSignatureNumerator,this.level.track.beatLength,e)}createTarget(t,e,i){const s=ct.indexFingerOnly?T:t.finger,n=new Tt(this.scene,this.songTime_,new o(t.normalizedPosition[0],t.normalizedPosition[1]),this.getPreviewTime(),this.level.track.getSoundKey(this.data,t.soundKey),this,s,i);n.setOnTargetMiss((()=>{this.level.score.missedPinch(n),this.progress.changeBy(-1),this.progress.redraw(),this.level.streak.stop(),this.targetManager.destroyTarget(n),this.checkForTransition(e,i)})),n.setOnTargetHit((()=>{const t=this.targetManager.getPreviousTargets(n);for(const i of t)Q(i!=n),this.progress.changeBy(-1),this.level.score.skippedPinch(i),this.checkForTransition(e,i.nodeIndex),this.targetManager.destroyTarget(i);t.length>0&&this.level.streak.stop();const s=this.songTime-n.songTime,o=n.onTimeDuration/2,a=s>o;s<-o?(this.level.streak.stop(),this.progress.changeBy(0),this.level.score.earlyPinch(n,this.songTime)):a?(this.level.streak.stop(),this.progress.changeBy(0),this.level.score.latePinch(n,this.songTime)):(this.level.streak.changeBy(1),this.progress.changeBy(1),this.level.score.onTimePinch(n,this.songTime,this.level.streak.current)),this.progress.redraw(),this.level.streak.check(),ct.sonificationEnabled&&n.sound.play({volume:ct.pinchVolume}),this.targetManager.destroyTarget(n),this.checkForTransition(e,i)})),this.targetManager.addTarget(n)}checkForTransition(t,e){e==this.data.nodes.length-1&&this.level.activeLayerIndex==t&&(ct.skipLayersAutomatically&&this.level.score.getLoopCount()>=ct.skipLayersAutomaticallyAfterLoop||this.progress.canProgress()&&!ct.disableLayerProgression?this.level.transitionLayers():(this.level.score.incrementLoopCount(),this.progress.setToStarting(),this.infoHud.updateLoopText(),ct.autoSaveCSV&&pt(this.level.score.levelStats)))}handleTargetCreation(){if(!this.ready)return;const t=this.getDuration();let e=this.songTime_+this.getPreviewTime();if(this.songTime_>0&&(e%=t),this.data.nodes.length<=this.nextNodeIndex){if(!(e<this.oldTimePosition))return;this.nextNodeIndex=0}const i=this.data.nodes[this.nextNodeIndex];this.level.track.songTimePositionToTime(i.timePosition)%t<=e&&(null!=i.finger&&this.createTarget(i,this.level.activeLayerIndex,this.nextNodeIndex),this.nextNodeIndex++),this.oldTimePosition=e}preDelayStop(){this.ready=!1,this.metronome.stop(),this.targetManager.destroyTargets()}postDelayStop(){this.infoHud.setVisible(!1),this.progress.setVisible(!1)}stop(){this.preDelayStop(),this.postDelayStop()}update(t){this.time=t,this.songTime_=this.ready?this.time-this.startTime:0,this.handleTargetCreation()}getPreviewTime(){return this.level.track.songTimePositionToTime({bar:this.data.previewTime.bar+1,step:this.data.previewTime.step+1,tick:this.data.previewTime.tick})}}class St extends l{constructor(t){super(t,"streak"),this.current_=0,this.onFire=!1,this.hsv=Phaser.Display.Color.HSVColorWheel(),this.streakText=this.scene.add.text(.05*t.width,.05*t.height,J,{font:_.font,color:_.color}).setOrigin(.5,.5).setVisible(!1).setScale(_.scale).setDepth(_.depth).setStroke(_.color,_.strokeThickness).setShadow(_.shadowOffset.x,_.shadowOffset.y,_.shadowColor,_.shadowBlurRadius,!0,!0),this.on("destroy",(()=>{this.onFireTween&&this.onFireTween.destroy(),this.flame&&this.flame.destroy(),this.streakText&&this.streakText.destroy()}))}get current(){return this.current_}changeBy(t){this.current_=Math.max(0,this.current+t)}check(){1===this.current_?this.start():this.current_>1?this.continue():this.stop()}updateStreakText(){this.streakText.setText("Streak: "+this.current_.toString())}start(){this.updateStreakText(),this.streakText.setVisible(!0)}stop(){this.current_=0,this.onFire=!1,this.onFireTween&&this.scene.tweens.remove(this.onFireTween),this.streakText&&this.streakText.clearTint(),this.streakText&&this.streakText.setVisible(!1),this.flame&&this.flame.destroy()}continue(){this.updateStreakText();const t=this.onFire;this.onFire=this.current_>=2,!t&&this.onFire&&(Q(!0,"Streak color wheel extent must be from 1 to 255"),this.onFireTween=this.scene.tweens.addCounter({from:0,to:30,duration:1e3,yoyo:!0,onUpdate:t=>{if(this&&this.hsv){const e=Math.floor(t.getValue()),i=this.hsv[e].color,s=this.hsv[30-e].color;this.streakText&&this.streakText.setTint(i,i,s,s)}},onStop:()=>{this.onFireTween&&this.scene.tweens.remove(this.onFireTween)}}),ct.postProcessingDisabled||(this.flame&&this.flame.destroy(),this.streakText&&(this.flame=this.scene.add.particles(this.streakText.x,this.streakText.y,"flare",H),Q(0!=_.depth),this.flame.setDepth(_.depth-1))))}}class Ct{constructor(){this.total=1,this.required=1,this.correct=0,this.early=0,this.late=0,this.miss=0,this.loop=1,this.hits=[]}}class Lt{constructor(t){this.maxStreak=0,this.layersStats=[],this.id=`${t.data.displayName.replace(/\s/g,"")}@${t.getBPM()}bpm_${(new Date).toLocaleString("en-GB").replace(/\s/g,"").replace(/,/g,"_").replace(/[:/]/g,"-")}`}}class Bt{constructor(t,e){this.scene=t,this.levelStats=new Lt(e),this.layerStats=new Ct}getLoopCount(){return this.layerStats.loop}incrementLoopCount(){this.layerStats.correct=0,this.layerStats.early=0,this.layerStats.late=0,this.layerStats.miss=0,this.layerStats.loop++}saveLayerScores(){this.levelStats.layersStats.push(this.layerStats)}resetLayerScores(t,e){this.layerStats=new Ct,this.layerStats.total=t,this.layerStats.required=e}addHit(t,e,i){this.layerStats.hits.push({loopNumber:this.getLoopCount(),noteID:t.nodeIndex+1,pinchType:t.fingerId,correctTime:t.songTime+this.delay,playerTime:e,classification:i,normalizedTargetRadius:t.normalizedRadius,normalizedTargetPosition:t.normalizedPosition,normalizedFingerRadius:this.scene.hand.getNormalizedFingerRadius(),normalizedPinkyFingerPosition:this.scene.hand.getNormalizedFingerPosition(S),normalizedRingFingerPosition:this.scene.hand.getNormalizedFingerPosition(P),normalizedMiddleFingerPosition:this.scene.hand.getNormalizedFingerPosition(k),normalizedIndexFingerPosition:this.scene.hand.getNormalizedFingerPosition(T),normalizedThumbFingerPosition:this.scene.hand.getNormalizedFingerPosition(x)})}onTimePinch(t,e,i){this.addHit(t,e+this.delay,"correct"),this.layerStats.correct++,this.levelStats.maxStreak=Math.max(i,this.levelStats.maxStreak)}earlyPinch(t,e){this.addHit(t,e+this.delay,"early"),this.layerStats.early++}latePinch(t,e){this.addHit(t,e+this.delay,"late"),this.layerStats.late++}skippedPinch(t){this.addHit(t,-1e3,"skipped"),this.layerStats.miss++}missedPinch(t){this.addHit(t,-1e3,"missed"),this.layerStats.miss++}}class Ot{constructor(t,e){this.trackKey_=J,this.finishCallback=()=>{},this.abortCallback=()=>{},this.activeLayerIndex=0,this.playableLayers=[],this.activeAudioTracks=[],this.bpmIndex_=-1,this.scene=t,this.trackKey_=e,this.track=new mt(t,this.trackKey_)}preload(t){this.scene=t,this.preloadPreview(),this.track.preload(t),this.preloadLayers()}unload(){this.track.unload()}setBPM(t){Q(-1!=t,"BPM must be set before starting the level"),this.track.setBPM(t),this.bpmIndex_=t}get bpmIndex(){return this.bpmIndex_}get trackKey(){return this.trackKey_}init(t){this.scene=t,this.streak=new St(this.scene),this.score=new Bt(t,this.track),this.playableLayers.forEach((t=>{t.init(this.scene)}))}getBackgroundTextureKey(){return this.trackKey+"/background.png"}getPreviewVideoKey(){return this.trackKey+"/preview.mp4"}hasCustomBackground(){return this.scene.textures.exists(this.getBackgroundTextureKey())}hasPreviewVideo(){return this.scene.cache.video.has(this.getPreviewVideoKey())}preloadPreview(){const t=m+this.getPreviewVideoKey(),e=m+this.getBackgroundTextureKey();this.scene.load.video(this.getPreviewVideoKey(),tt(t),!0),this.scene.load.image(this.getBackgroundTextureKey(),tt(e))}preloadLayers(){this.playableLayers=[],this.track.forEachLayer(void 0,((t,e)=>{const i=new Pt(this.scene,this,t);this.playableLayers.push(i)}))}unloadLayers(){this.playableLayers.forEach((t=>{t.unload()})),this.track.unload()}start(t,e){this.activeLayerIndex=0,this.removeBackgroundAudio(),this.playableLayers.forEach((t=>{t.stop()})),this.streak.stop(),this.setBPM(this.bpmIndex_),this.finishCallback=t,this.abortCallback=e,this.scene.time.delayedCall(1e3,(()=>{this.startLayer()}))}addBackgroundAudio(t,e,i){Q(-1!=this.bpmIndex_,"Set BPM before adding background audio to level"),this.removeBackgroundAudio(),this.activeAudioTracks=this.track.addBackgroundAudioTracks(t,e,this.bpmIndex_,i)}removeBackgroundAudio(){this.activeAudioTracks.forEach((t=>{t.stop(),this.scene.sound.remove(t)})),this.activeAudioTracks=[]}playBackgroundAudio(){this.activeAudioTracks.forEach((t=>{t.setMute(!1),t.play()}))}setBackgroundAudioMute(t){this.activeAudioTracks.forEach((e=>{e.setMute(t)}))}startLayer(){const t=this.getActiveLayer(),e=this.activeLayerIndex;this.score.resetLayerScores(t.data.nodes.length,t.data.progressCount);const i=this.track.songTimePositionToTime({bar:2,step:1,tick:0}),s=Math.max(i,t.getPreviewTime());t.start(s);const n=[...t.data.backgroundLayers];ct.synchronizationEnabled&&n.push(t.data.id),this.addBackgroundAudio(this.scene,{loop:!0,volume:ct.backgroundMusicVolume},((t,e)=>n.includes(t.id))),this.scene.time.delayedCall(s,(()=>{this.activeLayerIndex==e&&this.playBackgroundAudio()}))}getActiveLayer(){return Q(this.activeLayerIndex<this.playableLayers.length,"Active layer index cannot exceed number of playable layers"),this.playableLayers[this.activeLayerIndex]}transitionLayers(){if(ct.autoSaveCSV&&pt(this.score.levelStats),this.activeLayerIndex<this.playableLayers.length){const t=this.getActiveLayer();t.preDelayStop(),this.removeBackgroundAudio(),this.activeLayerIndex++;const e=this.activeLayerIndex;if(this.activeLayerIndex>=this.playableLayers.length)return this.score.saveLayerScores(),t.postDelayStop(),void this.end();this.scene.time.delayedCall(1e3,(()=>{this.activeLayerIndex==e&&(this.score.saveLayerScores(),t.postDelayStop(),this.startLayer())}))}}stop(){this.removeBackgroundAudio(),this.streak.stop()}end(){this.stop(),this.finishCallback()}abort(){ct.autoSaveCSV&&(this.score.saveLayerScores(),pt(this.score.levelStats)),this.stop(),this.abortCallback()}update(t){this.activeLayerIndex<this.playableLayers.length&&this.getActiveLayer().update(t)}getAudioLoopTime(){return Q(this.activeAudioTracks.length>=1,"Cannot retrieve audio loop time when there are no active audio tracks"),this.activeAudioTracks.at(-1).duration}}var It=function(t,e,i,s){return new(i||(i=Promise))((function(n,o){function a(t){try{r(s.next(t))}catch(t){o(t)}}function h(t){try{r(s.throw(t))}catch(t){o(t)}}function r(t){var e;t.done?n(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(a,h)}r((s=s.apply(t,e||[])).next())}))};let Dt;const Et=[];class Vt extends g{get normalizedPosition(){return this.normalizedPosition_}updatePosition(t,e){this.normalizedPosition_=[t,e],this.setPosition(t*this.scene.scale.width,e*this.scene.scale.height)}constructor(t,e,i,s,n="finger"){super(t.matter.world,0,0,n,void 0,{render:{visible:!0}}),this.normalizedPosition_=null,this.name=e,this.landmarkIndex=i,this.scene.add.existing(this),this.setScale(s),this.setTint(f[this.name]),this.setDepth(100);const o=this.displayWidth/2;this.normalizedRadius=o/t.scale.width,this.setCircle(o,{label:this.name}),this.setSensor(!0),ft(this,!1)}}var At,Nt;!function(t){t[t.hover=0]="hover",t[t.pinch=1]="pinch"}(At||(At={})),function(t){t[t.start=0]="start",t[t.continue=1]="continue",t[t.end=2]="end"}(Nt||(Nt={}));class Ft extends l{constructor(t){super(t,"hand"),this.fingers=[],this.observers_=[],this.fingers=[],this.observers_=[];const e=(t,e)=>{const i=new Vt(this.scene,t,e,.3*ct.fingerSize);return this.fingers.push(i),i},i=e(x,4),s=(e(T,8),e(k,12),e(P,16),e(S,20),(t,e)=>{t((t=>{const s=this.getFinger(t.bodyB.label);if(null!=s)for(const t of this.observers)t.fingerName==s.name&&t.object&&t.object.input&&t.object.input.enabled&&t.object.emit(s.name+At.pinch+e);else if(t.bodyB.gameObject){const s=t.bodyB.gameObject;for(const n of this.fingers){if(n==i)continue;const o={object:s,fingerName:n.name};if(!this.isObserver(o))continue;const a=this.scene.matter.overlap(t.bodyB,[n]);if(e===Nt.start&&a)s.emit(n.name+At.hover+Nt.start),this.setObserverHover(o,!0);else if(e===Nt.continue){const t=this.wasObserverHovering(o);a&&t?(s.emit(n.name+At.hover+Nt.continue),this.setObserverHover(o,!0)):a&&!t?(s.emit(n.name+At.hover+Nt.start),this.setObserverHover(o,!0)):!a&&t&&(s.emit(n.name+At.hover+Nt.end),this.setObserverHover(o,!1))}else e===Nt.end&&this.wasObserverHovering(o)&&(s.emit(n.name+At.hover+Nt.end),this.setObserverHover(o,!1))}}}))});s(i.setOnCollide.bind(i),Nt.start),s(i.setOnCollideActive.bind(i),Nt.continue),s(i.setOnCollideEnd.bind(i),Nt.end),this.on("destroy",(()=>{for(const t of this.fingers)t&&t.destroy()}))}getNormalizedFingerRadius(){for(const t of this.fingers)if(t)return t.normalizedRadius;return null}getNormalizedFingerPosition(t){const e=this.getFinger(t);return void 0===e?null:e.normalizedPosition}getFinger(t){const e=this.fingers.findIndex((e=>e.name==t));if(-1!==e)return this.fingers[e]}getFingersOtherThan(t){const e=[];for(const i of this.fingers)i&&i.name==t||e.push(i);return e}get observers(){return this.observers_}isObserver(t){return null!=this.observers_.find((e=>e.fingerName===t.fingerName&&e.object==t.object))}wasObserverHovering(t){return Q(this.isObserver(t)),this.observers_.find((e=>e.fingerName===t.fingerName&&e.object==t.object)).wasHovering}setObserverHover(t,e){const i=this.observers_.findIndex((e=>e.fingerName===t.fingerName&&e.object==t.object));Q(-1!==i,"Cannot set observer hover before observer is pushed"),this.observers_[i].wasHovering=e}pushNewObserversOnly(t){this.isObserver(t)||(this.observers.push(t),this.setObserverHover(t,!1))}removeObserver(t){const e=this.observers_.findIndex((e=>e.fingerName===t.fingerName&&e.object==t.object));e>-1&&this.observers_.splice(e,1)}setFingerScale(t){for(const e of this.fingers)e.setScale(.3*t)}addPinchCheck(t,e,i){this.pushNewObserversOnly({object:e,fingerName:t});const s=t=>{const i=this.getFinger(x),s=this.getFinger(t);if(void 0===i)return!1;if(void 0===s)return!1;const n=this.scene.matter.overlap(e,[i]),o=this.scene.matter.overlap(e,[s]);return n&&o},n=t=>{const e=this.getFingersOtherThan(t),i=this.getFinger(x);if(void 0===i)return!1;for(const t of e)if(t!=i&&void 0!==t&&this.scene.matter.overlap(i,[t]))return!0;return!1};i.startPinch&&e.on(t+At.pinch+Nt.start,(()=>{var e;s(t)&&(!ct.ignoreMultifingerPinches||ct.ignoreMultifingerPinches&&!n(t))&&(null===(e=i.startPinch)||void 0===e||e.call(i))})),i.pinched&&e.on(t+At.pinch+Nt.continue,(()=>{var e;s(t)&&(!ct.ignoreMultifingerPinches||ct.ignoreMultifingerPinches&&!n(t))&&(null===(e=i.pinched)||void 0===e||e.call(i))})),i.endPinch&&e.on(t+At.pinch+Nt.end,(()=>{var e;s(t)&&(!ct.ignoreMultifingerPinches||ct.ignoreMultifingerPinches&&!n(t))&&(null===(e=i.endPinch)||void 0===e||e.call(i))})),i.startHover&&e.on(t+At.hover+Nt.start,(()=>{var t;null===(t=i.startHover)||void 0===t||t.call(i)})),i.hovering&&e.on(t+At.hover+Nt.continue,(()=>{var t;null===(t=i.hovering)||void 0===t||t.call(i)})),i.endHover&&e.on(t+At.hover+Nt.end,(()=>{var t;null===(t=i.endHover)||void 0===t||t.call(i)}))}removePinchCheck(t,e){this.removeObserver({fingerName:t,object:e}),e.off(t+At.pinch+Nt.start),e.off(t+At.pinch+Nt.continue),e.off(t+At.pinch+Nt.end),e.off(t+At.hover+Nt.start),e.off(t+At.hover+Nt.continue),e.off(t+At.hover+Nt.end)}update(){this.observers_=this.observers_.filter((t=>null!=t)),ot.update();const t=this.scene.matter.add.circle(this.scene.input.mousePointer.x,this.scene.input.mousePointer.y,1,{circleRadius:1,isSensor:!0,render:{visible:!1}});for(const e of this.fingers){const i=ot.getNormalizedLandmarkPosition(e.landmarkIndex),s=null!=i;if(s&&e.updatePosition(i.x,i.y),ft(e,s),!s&&t)for(const i of this.observers)null!=t&&null!=i.object&&i.object.active&&null!=this.scene&&(i.object.emit(e.name+At.pinch+Nt.end),this.scene.matter.overlap(t,[i.object])||i.object.emit(e.name+At.hover+Nt.end))}this.scene.matter.world.remove(t)}calculateHandDistance(t=0){const e=ot.getNormalizedLandmarkPosition(5,t),i=ot.getNormalizedLandmarkPosition(17,t),s=ot.getNormalizedLandmarkPosition(0,t);let n=0,a=0;if(null!=e&&null!=i){const t=new o((e.x+i.x)/2,(e.y+i.y)/2);n=i.distanceSq(e),null!=s&&(a=s.distanceSq(t))}if(0==n||0==a)return 0;let h=Math.max(Math.sqrt(n)/8.2,Math.sqrt(a)/10);return h*=10,8.2*.7/h}}const Mt=new Set([[0,1],[0,5],[9,13],[13,17],[5,9],[0,17],[1,2],[2,3],[3,4],[5,6],[6,7],[7,8],[9,10],[10,11],[11,12],[13,14],[14,15],[15,16],[17,18],[18,19],[19,20]]);class zt extends u{constructor(t){super(t),this.bg=document.getElementById("background_image")}preload(){}enableCamera(t,e){it.setVisibility(t),this.setOpacity(e)}create(){this.width=this.scale.width,this.height=this.scale.height,this.center=new o(this.width/2,this.height/2),this.enableCamera(ct.enableCameraVisibility,ct.cameraOpacity),Dt.setVisible(!1),document.getElementById("background_image"),this.bg.style.opacity="1",this.setBackgroundTexture("background"),Dt.clearTint(),this.sound.pauseOnBlur=!1,this.graphicsObject=this.add.graphics(),this.graphicsObject.setDepth(99),this.hand=new Ft(this),this.input.topOnly=!1}update(t,e){it.video.width=this.game.canvas.clientWidth,it.video.height=this.game.canvas.clientHeight,this.graphicsObject.clear(),this.hand.update(),function(t,e,i=0){t.setDepth(99),ot.forEachNormalizedLandmarkPosition((i=>{const s=new o(t.scene.scale.width,t.scene.scale.height);i.multiply(s),t.lineStyle(e.lineWidth,e.color,e.alpha)}),i)}(this.graphicsObject,b,0),function(t,e,i=0){t.setDepth(98),Mt.forEach((s=>{const n=ot.getNormalizedLandmarkPosition(s[0],i);if(null!=n){const a=ot.getNormalizedLandmarkPosition(s[1],i);if(null!=a){const i=new o(t.scene.scale.width,t.scene.scale.height),s=n.multiply(i),h=a.multiply(i);t.lineStyle(e.lineWidth,e.color,e.alpha),t.lineBetween(s.x,s.y,h.x,h.y)}}}))}(this.graphicsObject,w,0)}setOpacity(t){if(null==t)return;Q(t>=0&&t<=1);const e=1-t;Dt.setAlpha(e),this.bg.style.opacity=e.toString()}setBackgroundTexture(t){Dt.setTexture(t),Dt.setDisplaySize(this.width,this.height),this.bg.style.backgroundSize="0 0",Dt.setVisible(!0)}}class _t extends wt{constructor(t,e,i,s,n=(()=>{}),o,a,h=!1,r="pinch"){super(t,e,i,s,n,o,r),this.spriteKey=o,this.toggledSpriteKey=a,this.toggleState=h,this.setTexture(this.getSpriteKey()),this.on("destroy",(()=>{this.scene.hand.removePinchCheck(L,this),this.sound&&(this.sound.isPlaying?this.sound.on("complete",(()=>{this.sound.destroy()})):this.sound.destroy()),this.text&&this.text.destroy()}))}setToggleState(t){var e;this.toggleState=t,this.setTexture(this.getSpriteKey()),null===(e=this.toggleCallback)||void 0===e||e.call(this,this.toggleState)}addToggleCallback(t){this.toggleCallback=t,this.toggleCallback(this.toggleState)}toggle(){var t;this.toggleState=!this.toggleState,this.setTexture(this.getSpriteKey()),null===(t=this.toggleCallback)||void 0===t||t.call(this,this.toggleState)}getToggleState(){return this.toggleState}updateTint(){this.toggleState?this.setTintFill(I):this.clearTint()}getSpriteKey(){return this.toggleState?this.spriteKey:this.toggledSpriteKey}}class Ht extends _t{constructor(t,e,i,s,n,o,a=(()=>{}),h,r,l=!1,d="pinch"){super(i,s,n,o,a,h,r,l,d),this.resetTint=!1,this.bpmIndex_=t,this.bpm=e;const c=this.getCenter();this.bpmText=this.scene.add.text(c.x,c.y+30,"BPM: "+this.bpm.toString(),{font:"20px Courier New"}).setOrigin(.5,.5),this.text&&(this.text.y-=10),this.updateTint(),this.on("destroy",(()=>{this.scene.hand.removePinchCheck(L,this),this.sound&&(this.sound.isPlaying?this.sound.on("complete",(()=>{this.sound.destroy()})):this.sound.destroy()),this.text&&this.text.destroy(),this.bpmText&&this.bpmText.destroy()}))}updateTint(){this.toggleState?(this.text&&this.text.setTintFill(D),this.bpmText.setTintFill(D),this.setTintFill(I)):(this.text&&this.text.clearTint(),this.bpmText.clearTint(),this.clearTint())}get bpmIndex(){return this.bpmIndex_}}var Kt=n().Math.Vector2,jt=n().Math.RoundTo;class Rt extends h{constructor(t,e,i,s,n,o,a,h,r){super(t),this.isDragging=!1,this.range=new Kt(0,1),this.isInteger=!1,this.x=e.x,this.y=e.y,this.width=i.x,this.height=i.y,this.key=o,this.updateSliderCallback=h,this.range=a,this.value=.5,this.box=new d(0,0,i.x,i.y),this.handle=new d(0,0,i.y,i.y),this.updateHandle(),s&&(this.label=this.scene.add.text(this.x+s.x,this.y+s.y,J,{color:"#ffffff",fontSize:"24px"})),this.setInteractive(this.box,d.Contains),this.on("pointerdown",this.startDrag,this),this.scene.input.on("pointerup",(()=>{this.stopDrag(),null==r||r()}),this),this.scene.input.on("pointermove",this.doDrag,this),Q("number"==typeof n[this.key],"Type must be number, instead it was: "+typeof n[this.key]),this.setValue(n[this.key]),this.draw(),this.on("destroy",(()=>{this.label&&this.label.destroy()}))}reset(t){Q("number"==typeof t[this.key],"Type must be number"),this.setValue(t[this.key]),this.draw()}startDrag(){this.isDragging=!0}doDrag(t){this.isDragging&&(this.value=n().Math.Clamp((t.x-this.x-this.handle.width/2)/(this.width-this.handle.width),0,1),this.updateHandle(),this.draw())}stopDrag(){this.isDragging=!1}updateHandle(){this.handle.x=this.value*(this.width-this.handle.width)}draw(){this.clear(),this.input&&(this.input.enabled||this.setInteractive(this.box,d.Contains),this.updateSliderCallback(this)),this.fillStyle(11184810),this.fillRectShape(this.box),this.fillStyle(16777215),this.fillRectShape(this.handle)}getStringValue(){const t=this.getValue();return this.isInteger?t.toFixed(0):t.toFixed(2)}getValue(){const t=this.value*(this.range.y-this.range.x)+this.range.x;return this.isInteger?jt(t,0):t}setIsInteger(t){return this.isInteger=t,this.draw(),this}setValue(t){this.value=(t-this.range.x)/(this.range.y-this.range.x),this.updateHandle(),this.draw()}hide(t){return this.clear(),this.input&&this.disableInteractive(),this.label&&this.label.active&&(t?this.label.setText(t):this.label.setText("")),this}}class $t extends h{constructor(t,e,i,s,n,o,a,h){super(t),this.labelText=J,this.x=e.x,this.y=e.y,this.key=a,s&&(this.labelText=n,this.label=this.scene.add.text(e.x+s.x,e.y+s.y,this.labelText,{color:"#ffffff",fontSize:"24px"})),this.toggleCallback=h,Q("boolean"==typeof o[this.key]),this.isChecked_=o[this.key],this.box=new d(0,0,i,i),this.check=new d(.25*i,.25*i,.5*i,.5*i),this.setInteractive(this.box,d.Contains),this.toggleCallback(this),this.on("pointerdown",this.toggleCheck,this),this.draw(),this.on("destroy",(()=>{this.label&&this.label.destroy()}))}reset(t){Q("boolean"==typeof t[this.key]),this.isChecked_=t[this.key],this.toggleCallback(this),this.draw()}resetLabel(){this.label&&this.label.setText(this.labelText)}setLabel(t){this.label&&this.label.setText(t),this.draw()}toggleCheck(){this.isChecked_=!this.isChecked_,this.toggleCallback(this),this.draw()}draw(){this.clear(),this.input&&!this.input.enabled&&this.setInteractive(this.box,d.Contains),this.lineStyle(2,16777215),this.strokeRectShape(this.box),this.isChecked_&&(this.fillStyle(16777215),this.fillRectShape(this.check))}setToggled(t){"boolean"==typeof t&&(this.isChecked_=t,this.toggleCallback(this),this.draw())}hide(){return this.clear(),this.disableInteractive(),this.label&&this.label.setText(""),this}get isChecked(){return this.isChecked_}}var Gt=i(223),qt=i(434),Wt=i(769),Ut=function(t,e,i,s){return new(i||(i=Promise))((function(n,o){function a(t){try{r(s.next(t))}catch(t){o(t)}}function h(t){try{r(s.throw(t))}catch(t){o(t)}}function r(t){var e;t.done?n(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(a,h)}r((s=s.apply(t,e||[])).next())}))};let Xt;const Yt={type:n().WEBGL,width:1920,height:1080,scale:{mode:n().Scale.ScaleModes.HEIGHT_CONTROLS_WIDTH,autoCenter:n().Scale.CENTER_BOTH},transparent:!0,physics:{default:"matter",matter:{debug:!1,gravity:{x:0,y:0}}},scene:[class extends u{constructor(){super("electron")}create(){return It(this,void 0,void 0,(function*(){yield new Promise(((t,e)=>{t()})).then((()=>{this.scene.start("loading")}))}))}},class extends u{constructor(){super({key:"loading",pack:{files:[{type:"json",key:"levelList",url:tt(y)},{type:"json",key:"defaultConfig",url:tt("data/default_config.json")}]}})}preload(){this.load.image("finger",tt("assets/sprites/finger.png")),this.load.image("button",tt("assets/ui/button.png")),this.load.image("targetOuter",tt("assets/sprites/target_outer.png")),this.load.image("targetInner",tt("assets/sprites/target_inner.png")),this.load.audio("pinch",tt("assets/sounds/ui/menu_ding.mp3")),this.load.image("title",tt("assets/ui/title.png")),this.load.image("background",tt("assets/ui/background.png")),this.load.image("levelBackground",tt("assets/ui/level_background.png")),this.load.image("levelChange",tt("assets/ui/level_change.png")),this.load.image("mute",tt("assets/ui/mute.png")),this.load.image("unmute",tt("assets/ui/unmute.png")),this.load.image("videoBackground",tt("assets/ui/video_background.png")),this.load.image("optionsBackground",tt("assets/ui/options_background.png")),this.load.image("calibrationBackground",tt("assets/ui/calibration_background.png")),this.load.image("defaultVideoBackground",tt("assets/ui/default_video_background.png")),this.load.image("songNameBackground",tt("assets/ui/song_name_background.png")),this.load.image("trackInfoBackground",tt("assets/ui/track_info_background.png")),this.load.image("countdown",tt("assets/sprites/countdown.png")),this.load.audio("metronomeHigh",tt("assets/sounds/metronome/high.mp3")),this.load.audio("metronomeLow",tt("assets/sounds/metronome/low.mp3")),this.load.image("scoreboardBackground1",tt("assets/ui/scoreboard_background1.png")),this.load.image("scoreboardBackground2",tt("assets/ui/scoreboard_background2.png")),this.load.image("progressSegment",tt("assets/ui/progress_segment.png")),this.load.image("flare",tt("assets/sprites/flare.png")),this.load.image("flare",tt("assets/sprites/flare.png")),this.cache.json.get("levelList").forEach(((t,e)=>{Et.push(new Ot(this,t))}))}create(){return It(this,void 0,void 0,(function*(){Dt=this.add.sprite(this.scale.width/2,this.scale.height/2,"background").setVisible(!1);const t=this.add.text(this.scale.width/2,this.scale.height/2,"",{font:"50px Courier New",color:"#00ff00"}).setOrigin(.5,.5).setShadow(1,1).setDepth(1e3);var e;yield it.init(U,this.game.canvas.clientWidth,this.game.canvas.clientHeight,this.updateText.bind(this,t)).catch((e=>{this.updateText(t,e)})),it.found()&&(yield ot.init(this.updateText.bind(this,t)).catch((e=>this.updateText(t,e))),ot.found()&&(it.setVisibility(U.visible),this.scene.launch(W),ot.precache(this.updateText.bind(this,t)),this.updateText(t,"LOADING CONFIG DATA..."),Q(this.cache.json.has("defaultConfig"),"Failed to load default config data"),e=this.cache.json.get("defaultConfig"),dt=e,console.info("INFO: Default config set to:"),console.info(dt),Xt?yield se().then((t=>{const[e,i]=t;console.info('INFO: Playing as "'+ee()+'" with config: "'+i+'"'),ut(e)})).catch((e=>{this.updateText(t,e)})):ut(dt),this.updateText(t,"LOADING GAME DATA..."),this.scene.get(W).load.on("complete",(()=>{this.updateText(t,"STARTING INITIAL SCENE..."),t.destroy()}))))}))}updateText(t,e){console.info("INFO: "+e);let i=e;e instanceof DOMException&&(i="NotFoundError"==e.name?"WEBCAM NOT FOUND":"PermissionError"==e.name?"WEBCAM PERMISSION DENIED":"NotADirectoryError"==e.name?e.message:e.name+": "+e.message),t.setText(i)}},class extends zt{constructor(){super("mainMenu")}preload(){Et.forEach((t=>{t.preload(this)}))}create(){super.create(),Et.forEach((t=>{t.setBPM(0)})),this.calibration=new wt(this,"SETUP\nCAMERA",this.center.x-500,800,(()=>{this.scene.start("calibration")})),this.options=new wt(this,"OPTIONS",this.center.x+500,800,(()=>{this.scene.start("options")})),this.levelSelect=new wt(this,"SELECT\nLEVEL",this.center.x,800,(()=>{this.scene.start("levelSelect")})),this.title=this.add.sprite(this.center.x,360,"title")}update(t,e){super.update(t,e)}},class extends zt{constructor(){super("options"),this.options=[]}saveAndExit(){it.setVisibility(ct.enableCameraVisibility),this.rotateTween&&this.rotateTween.destroy(),this.glowTween&&this.glowTween.destroy(),this.glow&&this.glow.destroy(),this.scene.start("mainMenu")}create(){super.create(),this.onTimeDurationLimits=new o(50,1e3),this.createOptions()}normalizeDuration(t){if(t<0)return.001;const e=(t-this.onTimeDurationLimits.x)/(this.onTimeDurationLimits.y-this.onTimeDurationLimits.x);return 1-Math.max(0,Math.min(1,e))}setGlowTimeScale(t){this.glowTween.setTimeScale(this.normalizeDuration(t))}createOptions(){Q(null!=ct,"Failed to fetch configuration data");const t=new o(.26*this.width,.03*this.height),e=.15*this.width;this.back=new wt(this,"BACK",this.center.x-e,this.height-100,(()=>{this.saveAndExit()})),this.resetConfig=new wt(this,"RESET TO\nDEFAULT",this.center.x+e,this.height-100,(()=>{console.info("INFO: Reset config to default"),ut(dt,!1);for(const t of this.options)t.reset(ct);this.setGlowTimeScale(ct.onTimeDuration/2),it.setVisibility(ct.enableCameraVisibility)})),this.input.keyboard.on(z,(()=>{this.saveAndExit()})),this.add.sprite(.09*this.width,.05*this.height,"optionsBackground").setOrigin(0,0).setAlpha(.8).setDisplaySize(.28*this.width,.185*this.height),this.add.sprite(.09*this.width,.26*this.height,"optionsBackground").setOrigin(0,0).setAlpha(.8).setDisplaySize(.28*this.width,.27*this.height),this.add.sprite(.09*this.width,.55*this.height,"optionsBackground").setOrigin(0,0).setAlpha(.8).setDisplaySize(.28*this.width,.23*this.height),this.add.sprite(.63*this.width,.05*this.height,"optionsBackground").setOrigin(0,0).setAlpha(.8).setDisplaySize(.28*this.width,.185*this.height),this.add.sprite(.63*this.width,.26*this.height,"optionsBackground").setOrigin(0,0).setAlpha(.8).setDisplaySize(.28*this.width,.27*this.height),this.add.sprite(.63*this.width,.55*this.height,"optionsBackground").setOrigin(0,0).setAlpha(.8).setDisplaySize(.28*this.width,.23*this.height),this.targetExample=this.add.sprite(.5*this.width,.1*this.height+.08*this.height*0+.15*this.height,"targetInner").setTint(f[x]).setScale(ct.targetSize),this.rotateTween=this.tweens.add({targets:[this.targetExample],rotation:2*Math.PI,ease:"Power0",duration:1e3,repeat:-1}),this.glow=this.targetExample.postFX.addGlow(E,0,0,!1,.05,24);const i=ct.onTimeDuration/2;this.glowTween=this.tweens.add({targets:this.glow,outerStrength:4,yoyo:!0,duration:i,ease:V,repeat:-1}),this.setGlowTimeScale(i),ct.postProcessingDisabled&&this.glowTween&&this.glowTween.pause();const s=new Rt(this,new o(.1*this.width,.1*this.height+.08*this.height*0),t,new o(0,q.y),ct,"targetSize",new o(.5,3),(t=>{t.label.setText("Target Scale: "+t.getStringValue());const e=t.getValue();gt(t.key,e),this.targetExample.setScale(e)}));this.options.push(s),this.add.existing(s);const n=new Rt(this,new o(.1*this.width,.1*this.height+.08*this.height*1),t,new o(0,q.y),ct,"fingerSize",new o(.5,3),(t=>{t.label&&t.label.setText("Finger Scale: "+t.getStringValue());const e=t.getValue();gt(t.key,e),this.hand.setFingerScale(e)}));this.options.push(n),this.add.existing(n);const a=t=>{null!=t&&t.active&&(t.label&&t.label.active&&t.label.setText("Camera Opacity: "+t.getStringValue()),gt(t.key,t.getValue()),this.setOpacity(ct[t.key]))},h=new Rt(this,new o(.1*this.width,.32*this.height+.08*this.height*0),t,q,ct,"cameraOpacity",new o(.01,1),a),r=new $t(this,new o(.1*this.width,.32*this.height+.08*this.height*0+G.y),25,void 0,J,ct,"enableCameraVisibility",(t=>{gt(t.key,t.isChecked),it.setVisibility(t.isChecked),t.isChecked?h.draw():(h.setValue(ct.cameraOpacity),a(h),this.setOpacity(0),h.hide("Show Camera"))}));this.options.push(h),this.options.push(r),this.add.existing(h),this.add.existing(r);const l=new Rt(this,new o(.1*this.width,.32*this.height+.08*this.height*1),t,q,ct,"skipButtonAppearsAfterLoop",new o(1,16),(t=>{t.label.setText("Skip Button After Loop: "+t.getStringValue()),gt(t.key,t.getValue())})).setIsInteger(!0),d=new $t(this,new o(.1*this.width,.32*this.height+.08*this.height*1+G.y),25,void 0,J,ct,"showSkipButton",(t=>{gt(t.key,t.isChecked),t.isChecked?l.draw():l.hide("Show Layer Skip Button")}));this.options.push(l),this.options.push(d),this.add.existing(l),this.add.existing(d);const c=new Rt(this,new o(.1*this.width,.32*this.height+.08*this.height*2),t,q,ct,"skipLayersAutomaticallyAfterLoop",new o(1,16),(t=>{t.label.setText("Skip Layers After Loop: "+t.getStringValue()),gt(t.key,t.getValue())})).setIsInteger(!0),u=new $t(this,new o(.1*this.width,.32*this.height+.08*this.height*2+G.y),25,void 0,J,ct,"skipLayersAutomatically",(t=>{gt(t.key,t.isChecked),t.isChecked?c.draw():c.hide("Skip Layers Automatically")}));this.options.push(c),this.options.push(u),this.add.existing(c),this.add.existing(u);const g=new $t(this,new o(.1*this.width,.57*this.height+.08*this.height*0),25,new o(-G.x,0),"Disable Layer Progression",ct,"disableLayerProgression",(t=>{gt(t.key,t.isChecked)}));this.options.push(g),this.add.existing(g);const p=new $t(this,new o(.1*this.width,.57*this.height+.08*this.height*1),25,new o(-G.x,0),"Index Finger Pinches Only",ct,"indexFingerOnly",(t=>{gt(t.key,t.isChecked)}));this.options.push(p),this.add.existing(p);const m=new $t(this,new o(.1*this.width,.57*this.height+.08*this.height*2),25,new o(-G.x,0),"Disable Post-Processing",ct,"postProcessingDisabled",(t=>{gt(t.key,t.isChecked),t.isChecked?(this.glowTween&&(this.glowTween.restart(),this.glowTween.pause()),this.glow&&this.targetExample.postFX.disable()):t.isChecked||(this.glowTween&&this.targetExample&&this.glowTween.resume(),this.glow&&this.targetExample.postFX.enable())}));this.options.push(m),this.add.existing(m);const y=new Rt(this,new o(.64*this.width,.1*this.height+.08*this.height*0),t,new o(0,q.y),ct,"onTimeDuration",this.onTimeDurationLimits,(t=>{t.label.setText("On Time Duration: "+t.getStringValue()+" ms"),gt(t.key,t.getValue()),this.setGlowTimeScale(ct.onTimeDuration/2)})).setIsInteger(!0);this.options.push(y),this.add.existing(y);const v=new Rt(this,new o(.64*this.width,.1*this.height+.08*this.height*1),t,new o(0,q.y),ct,"lateTimeDuration",new o(50,1e3),(t=>{t.label.setText("Late Time Duration: "+t.getStringValue()+" ms"),gt(t.key,t.getValue())})).setIsInteger(!0);this.options.push(v),this.add.existing(v);const w=new Rt(this,new o(.64*this.width,.3*this.height+.07*this.height*0),t,new o(0,q.y),ct,"pinchVolume",new o(0,1),(t=>{t.label.setText("Pinch Volume: "+t.getStringValue()),gt(t.key,t.getValue())}));this.options.push(w),this.add.existing(w);const b=new Rt(this,new o(.64*this.width,.3*this.height+.07*this.height*1),t,new o(0,q.y),ct,"backgroundMusicVolume",new o(0,1),(t=>{t.label.setText("Track Volume: "+t.getStringValue()),gt(t.key,t.getValue())}));this.options.push(b),this.add.existing(b);const T=new $t(this,new o(.64*this.width,.33*this.height+.08*this.height*1),25,new o(-G.x,0),"Enable UI Pinches",ct,"uiPinchesEnabled",(t=>{gt(t.key,t.isChecked)}));this.options.push(T),this.add.existing(T);const k=new $t(this,new o(.64*this.width,.33*this.height+.08*this.height*1.5),25,new o(-G.x,0),"Enable Mouse Pinches",ct,"mousePinchesEnabled",(t=>{gt(t.key,t.isChecked)}));this.options.push(k),this.add.existing(k);const P=new $t(this,new o(.64*this.width,.33*this.height+.08*this.height*2),25,new o(-G.x,0),"Ignore Multifinger Pinches",ct,"ignoreMultifingerPinches",(t=>{gt(t.key,t.isChecked)}));this.options.push(P),this.add.existing(P);const S=new $t(this,new o(.64*this.width,.57*this.height+.08*this.height*0),25,new o(-G.x,0),"Display Visual Metronome",ct,"displayVisualMetronome",(t=>{gt(t.key,t.isChecked)}));this.options.push(S),this.add.existing(S);const C=new $t(this,new o(.64*this.width,.57*this.height+.08*this.height*.5),25,new o(-G.x,0),"Enable Sonification",ct,"sonificationEnabled",(t=>{gt(t.key,t.isChecked)}));this.options.push(C),this.add.existing(C);const L=new $t(this,new o(.64*this.width,.57*this.height+.08*this.height*1),25,new o(-G.x,0),"Enable Synchronization",ct,"synchronizationEnabled",(t=>{gt(t.key,t.isChecked)}));this.options.push(L),this.add.existing(L);const B=new $t(this,new o(.64*this.width,.57*this.height+.08*this.height*1.5),25,new o(-G.x,0),"Enable Unplayable Backing Tracks",ct,"unplayableBackingTracksEnabled",(t=>{gt(t.key,t.isChecked)}));this.options.push(B),this.add.existing(B);const O=new $t(this,new o(.64*this.width,.57*this.height+.08*this.height*2),25,new o(-G.x,0),"Enable Playable Backing Tracks",ct,"playableBackingTracksEnabled",(t=>{gt(t.key,t.isChecked)}));this.options.push(O),this.add.existing(O)}update(t,e){super.update(t,e)}},class extends zt{constructor(){super("levelSelect"),this.currentLevelIndex=0,this.difficultyButtons=[],this.videoOffsetY=124,Q(this.currentLevelIndex>=0,"Level select default level must be >= 0")}preload(){Q(this.currentLevelIndex<Et.length,"Cannot set defaut level select index above the number of levels")}create(){super.create(),this.play=new wt(this,"PLAY",this.center.x,this.height-100,(()=>{this.startLevel(this.getCurrentLevel())})),this.previousLevel=new wt(this,"",this.center.x-450,75,(()=>{this.updateLevel(-1)}),"levelChange"),this.previousLevel.setFlipX(!0),this.nextLevel=new wt(this,"",this.center.x+450,75,(()=>{this.updateLevel(1)}),"levelChange"),this.back=new wt(this,"BACK",200,this.height-100,(()=>{this.scene.start("mainMenu"),this.exit()}));const t=new o(75);this.mute=new _t(this,"",this.width-t.x,this.height-t.y,(()=>{this.mute.toggle()}),"mute","unmute",!0),this.input.keyboard.on(z,(()=>{this.scene.start("mainMenu"),this.exit()})),this.add.sprite(this.center.x,this.center.y-this.videoOffsetY,"videoBackground"),this.add.sprite(this.center.x,0,"songNameBackground").setOrigin(.5,0),this.songName=this.add.text(this.center.x,75,J,{font:"50px Courier New",color:"white"}).setOrigin(.5,.5),this.updateLevel(0),this.mute.addToggleCallback((t=>{this.setBackgroundAudioMute(!t)}))}exit(){for(const t of this.difficultyButtons)t.destroy();this.stopAudio()}startLevel(t){this.exit(),this.scene.start("level",t)}createDifficultyButtons(t){for(const t of this.difficultyButtons)t.destroy();this.difficultyButtons=[];const e=t.track.data.bpm,i=[new o(this.center.x-384,766),new o(this.center.x,766),new o(this.center.x+384,766)];Q(i.length>=e.length,"positions array length must at least match the number of track bpms");const s=[j,R,$];for(let n=0;n<e.length;n++){const o=new Ht(n,e[n],this,s[n],i[n].x,i[n].y,(()=>{for(const t of this.getDifficultyButtons())t!=o&&t.setToggleState(!1);o.setToggleState(!0)}),"button","button",0==n);o.setScale(.8),o.updateTint(),o.addToggleCallback((e=>{o.updateTint(),e&&(t.setBPM(o.bpmIndex),this.startPreview(t))})),this.difficultyButtons.push(o)}}getDifficultyButtons(){return this.difficultyButtons}setBackgroundAudioMute(t){for(const e of Et)e.setBackgroundAudioMute(t)}startVideo(t){if(this.videoPreview&&this.videoPreview.destroy(),t.hasPreviewVideo()){this.videoPreview=this.add.video(this.center.x,this.center.y-this.videoOffsetY,t.getPreviewVideoKey()),this.videoPreview;const e=t.track.data.bpm[t.bpmIndex]/t.track.data.bpm[0];this.videoPreview.video&&(this.videoPreview.video.playbackRate=e),this.videoPreview.play(!0)}else this.videoPreview=this.add.sprite(this.center.x,this.center.y-this.videoOffsetY,"defaultVideoBackground");this.videoPreview.setScale(.6)}startPreview(t){this.stopAudio(),t.addBackgroundAudio(this,{loop:!0,volume:.5*ct.backgroundMusicVolume}),t.playBackgroundAudio(),t.setBackgroundAudioMute(!this.mute.getToggleState());let e=0;t.activeAudioTracks.length>=1&&t.hasPreviewVideo()?e=1e3*t.getAudioLoopTime():(this.startVideo(t),t.hasPreviewVideo()&&(e=this.videoPreview.getDuration())),0!=e&&t.hasPreviewVideo()&&(this.videoRefreshEvent=this.time.addEvent({delay:e,callback:()=>{this.startVideo(t)},callbackScope:this,loop:!0,startAt:e}))}stopAudio(){this.videoRefreshEvent&&this.videoRefreshEvent.destroy();for(const t of Et)t.removeBackgroundAudio()}updateLevel(t){this.cycleLevel(t);const e=this.getCurrentLevel();this.songName.setText(e.track.data.displayName),Q(0<e.track.data.bpm.length,"Default difficulty button index must be in range of default track BPM"),e.setBPM(0),this.startPreview(e),this.createDifficultyButtons(e)}cycleLevel(t){const e=Et.length;this.currentLevelIndex=((this.currentLevelIndex+t)%e+e)%e}getCurrentLevel(){return Q(this.currentLevelIndex<Et.length,"Current level index out of range of this.levels array"),Et[this.currentLevelIndex]}getCurrentLevelKey(){return"level"+(this.currentLevelIndex+1).toString()}update(t,e){super.update(t,e)}},class extends zt{constructor(){super("level")}preload(){this.level=this.scene.settings.data}create(){super.create(),this.level.init(this),this.level.hasCustomBackground()?this.setBackgroundTexture(this.level.getBackgroundTextureKey()):this.setBackgroundTexture("levelBackground"),this.input.keyboard.on(z,(()=>{this.level.abort()})),this.level.start((()=>{this.scene.start("scoreboard",this.level)}),(()=>{this.scene.start(W)}))}update(t,e){super.update(t,e),this.level.update(t)}},class extends zt{constructor(){super("scoreboard")}exit(){this.level.removeBackgroundAudio(),this.scene.start("mainMenu")}preload(){this.level=this.scene.settings.data,this.levelStats=this.level.score.levelStats,ct.autoSaveCSV&&pt(this.level.score.levelStats)}create(){super.create(),this.back=new wt(this,"BACK",this.center.x,this.height-100,(()=>{this.exit()}));const t=new o(75);this.mute=new _t(this,"",this.width-t.x,this.height-t.y,(()=>{this.mute.toggle()}),"mute","unmute",!0),this.level.addBackgroundAudio(this,{loop:!0,volume:.5*ct.backgroundMusicVolume}),this.level.playBackgroundAudio(),this.mute.addToggleCallback((t=>{this.level.setBackgroundAudioMute(!t)})),this.input.keyboard.on(z,(()=>{this.exit()})),ct.autoSaveCSV||(this.save=new wt(this,"SAVE CSV",200,this.height-100,(()=>{!function(t){const e=new Blob([at(t)],{type:"text/plain;charset=utf-8"});lt().saveAs(e,t.id+".csv")}(this.levelStats)}))),this.add.sprite(0,0,"scoreboardBackground1").setScale(1.35,1.25).setAlpha(.6).setPosition(this.center.x,.25*this.height);const e=this.add.text(this.center.x,0,"Scoreboard",{color:"#01c303",font:"96px Courier New"});e.setStroke("#000",6),e.setPosition(this.center.x-e.width/2,.07*this.height);const i=this.levelStats.layersStats.reduce(((t,e)=>t+e.total),0),s=this.levelStats.layersStats.reduce(((t,e)=>t+e.correct),0),n=this.levelStats.layersStats.reduce(((t,e)=>t+e.miss),0),a=this.levelStats.layersStats.reduce(((t,e)=>t+e.early),0),h=this.levelStats.layersStats.reduce(((t,e)=>t+e.late),0),r=this.add.text(this.center.x,0,`Total Correct: ${s.toString()}/${i.toString()}\nLongest Streak: ${this.levelStats.maxStreak}\nMissed: ${n}\nEarly: ${a}\nLate: ${h}`,{color:"#ffffff",align:"center",font:"48px Courier New"});r.setPosition(this.center.x-r.width/2,.19*this.height);const l=[.25,.5,.75],d=l;this.level.track.forEachLayer(void 0,((t,e)=>{this.add.sprite(0,0,"scoreboardBackground2").setScale(1.35,1.15).setAlpha(.6).setPosition(this.width*l[e],.63*this.height);const i=this.add.text(0,0,`${s=t.id,s&&s[0].toUpperCase()+s.slice(1)||""}`,{color:"#01c303",align:"center",font:"72px Courier New",fontStyle:"bold"});var s;i.setStroke("#000",4),i.setPosition(this.width*d[e]-i.width/2,.53*this.height);const n=this.levelStats.layersStats[e];let o=0,a=0,h=0;n&&(o=n.correct,a=n.total,h=n.loop);const r=this.add.text(0,0,`\nCorrect: ${o.toString()}/${a.toString()}\nLoops: ${h.toString()}`,{color:"#ffffff",align:"center",font:"48px Courier New"});r.setPosition(this.width*d[e]-r.width/2,.575*this.height+.01)}))}update(t,e){super.update(t,e)}},class extends zt{constructor(){super("calibration")}exit(){this.scene.start("mainMenu")}create(){super.create(),this.enableCamera(!0,.8),this.back=new wt(this,"BACK",this.center.x,this.height-100,(()=>{this.exit()})),this.setBackgroundTexture("calibrationBackground"),this.input.keyboard.on(z,(()=>{this.exit()})),this.distanceText=this.add.text(this.center.x,.1*this.height,J,{color:"white",font:"50px Courier New"}).setOrigin(.5,.5).setShadow(5,5,"rgba(0,0,0,0.5)",15)}update(t,e){super.update(t,e);const i=this.hand.calculateHandDistance();let s="Hand Not Recognized";if(i>0){let t=65280;i>40?(s="Too Far - Estimated Distance: ",t=16711680):i<20?(s="Too Close - Estimated Distance: ",t=255):s="Optimal - Estimated Distance: ",Dt.setTint(t),s+=i.toFixed(0)+" cm"}else Dt.clearTint();this.distanceText&&this.distanceText.active&&this.distanceText.setText(s)}}]};function Jt(){new(n().Game)(Yt)}const Qt=(0,Gt.Wp)({apiKey:"AIzaSyAHkhSVhXo1qrE3lYqXEh2ozwOgZJhk960",authDomain:"pizzicato-1f765.firebaseapp.com",projectId:"pizzicato-1f765",storageBucket:"pizzicato-1f765.firebasestorage.app",messagingSenderId:"196367706867",appId:"1:196367706867:web:bb5cac34655842ac462586",databaseURL:"https://pizzicato-1f765-default-rtdb.europe-west1.firebasedatabase.app/"}),Zt=((0,qt.xI)(Qt),(0,Wt.C3)(Qt)),te="@pizzicato.com";function ee(){return Xt?Xt.email.replace(te,""):"guest"}function ie(t,e){return Ut(this,void 0,void 0,(function*(){return new Promise(((i,s)=>{const n=(0,Wt.KR)(Zt,`users/${Xt.uid}/data/${t}`);(0,Wt.hZ)(n,e).then((()=>{i('Data written successfully for user "'+ee()+'"')})).catch((t=>{s('Data not found for user "'+ee()+'":'+t)}))}))}))}function se(){return Ut(this,void 0,void 0,(function*(){return new Promise(((t,e)=>{const i=(0,Wt.KR)(Zt);(0,Wt.Jt)((0,Wt.jf)(i,`users/${Xt.uid}`)).then((i=>{if(i.exists()){const s=i.val();(function(t){return Ut(this,void 0,void 0,(function*(){return new Promise(((e,i)=>{if(t){const s=(0,Wt.KR)(Zt);(0,Wt.Jt)((0,Wt.jf)(s,`configs/${t}`)).then((s=>{s.exists()?e(s.val()):i('Config "'+t+'" not found in database')})).catch((t=>{i("Firebase get configs failed: "+t)}))}else i("Undefined config name")}))}))})(s.config).then((i=>{s.config?t([i,s.config]):e("Undefined config name")})).catch((t=>{e("Failed to retrieve config: "+t)}))}else e("User id snapshot does not exist")})).catch((t=>{e("Firebase get users failed: "+t)}))}))}))}document.body.innerHTML+='<div id="background_image"></div>',Jt()}},i={};function s(t){var n=i[t];if(void 0!==n)return n.exports;var o=i[t]={exports:{}};return e[t].call(o.exports,o,o.exports,s),o.exports}s.m=e,t=[],s.O=(e,i,n,o)=>{if(!i){var a=1/0;for(d=0;d<t.length;d++){for(var[i,n,o]=t[d],h=!0,r=0;r<i.length;r++)(!1&o||a>=o)&&Object.keys(s.O).every((t=>s.O[t](i[r])))?i.splice(r--,1):(h=!1,o<a&&(a=o));if(h){t.splice(d--,1);var l=n();void 0!==l&&(e=l)}}return e}o=o||0;for(var d=t.length;d>0&&t[d-1][2]>o;d--)t[d]=t[d-1];t[d]=[i,n,o]},s.n=t=>{var e=t&&t.__esModule?()=>t.default:()=>t;return s.d(e,{a:e}),e},s.d=(t,e)=>{for(var i in e)s.o(e,i)&&!s.o(t,i)&&Object.defineProperty(t,i,{enumerable:!0,get:e[i]})},s.g=function(){if("object"==typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(t){if("object"==typeof window)return window}}(),s.o=(t,e)=>Object.prototype.hasOwnProperty.call(t,e),(()=>{var t={792:0};s.O.j=e=>0===t[e];var e=(e,i)=>{var n,o,[a,h,r]=i,l=0;if(a.some((e=>0!==t[e]))){for(n in h)s.o(h,n)&&(s.m[n]=h[n]);if(r)var d=r(s)}for(e&&e(i);l<a.length;l++)o=a[l],s.o(t,o)&&t[o]&&t[o][0](),t[o]=0;return s.O(d)},i=self.webpackChunkPizzicato=self.webpackChunkPizzicato||[];i.forEach(e.bind(null,0)),i.push=e.bind(null,i.push.bind(i))})();var n=s.O(void 0,[96],(()=>s(852)));n=s.O(n)})();